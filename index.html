import React, { useState, useEffect, useRef } from 'react';
import { Wrench, Archive, Plus, Save, Upload, Activity, Droplets, Trash2, Calendar, FileText, Download, Info, X, TrendingDown, Bell, ChevronDown, FolderOpen } from 'lucide-react';
import { initializeApp, getApps, getApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from 'firebase/firestore';

// --- FIREBASE SETUP ---
const userFirebaseConfig = {
  apiKey: "AIzaSyDGmN-60JoFMFyKNtEVR4sRf258GTv2jU4",
  authDomain: "mjodbryggning.firebaseapp.com",
  projectId: "mjodbryggning",
  storageBucket: "mjodbryggning.firebasestorage.app",
  messagingSenderId: "795065616004",
  appId: "1:795065616004:web:27f329729112c0f09fa4d1",
  measurementId: "G-1GDMF1NNQ4"
};

let firebaseConfig;
if (typeof __firebase_config !== 'undefined') {
  try {
    firebaseConfig = JSON.parse(__firebase_config);
  } catch (e) {
    firebaseConfig = userFirebaseConfig;
  }
} else {
  firebaseConfig = userFirebaseConfig;
}

let app;
if (getApps().length === 0) {
  app = initializeApp(firebaseConfig);
} else {
  app = getApp();
}

const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : "mjodbryggning-live";

export default function App() {
  // --- STATE ---
  const [user, setUser] = useState(null);
  const [currentBatchId, setCurrentBatchId] = useState(null);
  const [showInfo, setShowInfo] = useState(false); 
  
  // UI States
  const [showBatchMenu, setShowBatchMenu] = useState(false); // För dropdown-menyn
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [batchToDelete, setBatchToDelete] = useState(null);
  const [showReminderMenu, setShowReminderMenu] = useState(false);
  const [reminderType, setReminderType] = useState('measure');

  // Validering
  const [nameError, setNameError] = useState(false);
  
  // Datafält
  const [batchName, setBatchName] = useState('');
  const [startDate, setStartDate] = useState(new Date().toISOString().split('T')[0]);
  const [ingredients, setIngredients] = useState('');
  const [log, setLog] = useState(''); 
  
  const [og, setOg] = useState(0);
  const [ogTemp, setOgTemp] = useState(20);

  const [fg, setFg] = useState(0);
  const [fgTemp, setFgTemp] = useState(20);

  const [savedBatches, setSavedBatches] = useState([]);

  const fileInputRef = useRef(null);
  const batchMenuRef = useRef(null); // För att kunna klicka utanför menyn

  // --- EFFECT: Klicka utanför för att stänga meny ---
  useEffect(() => {
    function handleClickOutside(event) {
      if (batchMenuRef.current && !batchMenuRef.current.contains(event.target)) {
        setShowBatchMenu(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [batchMenuRef]);

  // --- TAILWIND FIX & AUTH ---
  useEffect(() => {
    // 1. Ladda Tailwind manuellt om det saknas (Fixar vit skärm på GitHub om lokal build failar)
    // Vi kollar om vi har några stilar applicerade eller om scriptet redan finns
    const isTailwindLoaded = !!window.tailwind || document.getElementById('tailwind-cdn');
    
    if (!isTailwindLoaded) {
      console.log("Laddar Tailwind CSS via CDN...");
      const script = document.createElement('script');
      script.id = 'tailwind-cdn';
      script.src = "https://cdn.tailwindcss.com";
      document.head.appendChild(script);
    }

    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        try {
          await signInWithCustomToken(auth, __initial_auth_token);
        } catch (e) {
          console.warn("Custom token auth failed, falling back to anonymous", e);
          await signInAnonymously(auth);
        }
      } else {
        await signInAnonymously(auth).catch((error) => {
           console.error("Inloggning misslyckades", error);
        });
      }
    };
    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
    });
    return () => unsubscribe();
  }, []);

  // --- FIREBASE DATA SYNC ---
  useEffect(() => {
    if (!user) return;

    const unsubscribe = onSnapshot(
      collection(db, 'artifacts', appId, 'users', user.uid, 'batches'),
      (snapshot) => {
        const batches = snapshot.docs.map(doc => ({ 
          id: parseInt(doc.id), 
          ...doc.data() 
        }));
        setSavedBatches(batches.sort((a, b) => b.id - a.id));
      },
      (error) => {
        console.error("Kunde inte hämta batcher:", error);
      }
    );

    return () => unsubscribe();
  }, [user]);

  // --- BERÄKNINGSFUNKTIONER ---
  
  const getCorrectedGravity = (gravity, temp) => {
    const g = parseFloat(gravity);
    const t = parseFloat(temp);
    if (isNaN(g) || isNaN(t)) return 0;
    const correction = (t - 20) * 0.2;
    return g + correction;
  };

  const calculatePotentialABV = () => {
    const correctedOG = getCorrectedGravity(og, ogTemp);
    const abv = Math.max(0, correctedOG / 7.5);
    return abv.toFixed(1);
  };

  const calculateCurrentABV = () => {
    const correctedOG = getCorrectedGravity(og, ogTemp);
    const correctedFG = getCorrectedGravity(fg, fgTemp);
    if (correctedOG <= 0) return "0.0";
    const diff = correctedOG - correctedFG;
    const abv = Math.max(0, diff / 7.5);
    return abv.toFixed(1);
  };

  const calculateAttenuation = () => {
    const correctedOG = getCorrectedGravity(og, ogTemp);
    const correctedFG = getCorrectedGravity(fg, fgTemp);
    if (correctedOG <= 0) return "0.0";
    const diff = correctedOG - correctedFG;
    const att = (diff / correctedOG) * 100;
    return Math.max(0, Math.min(100, att)).toFixed(1);
  };

  const getDaysSince = (dateString) => {
    if (!dateString) return 0;
    const start = new Date(dateString);
    const today = new Date();
    start.setHours(0, 0, 0, 0);
    today.setHours(0, 0, 0, 0);
    const diffTime = today.getTime() - start.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    return Math.max(0, diffDays);
  };

  const getSweetnessStatus = () => {
    const correctedFG = getCorrectedGravity(fg, fgTemp);
    if (og == 0 && fg == 0) return "-";
    if (correctedFG >= 45) return "Dessert / Mycket sött";
    if (correctedFG >= 25) return "Sött";
    if (correctedFG >= 12) return "Halvsött";
    if (correctedFG >= 4) return "Halvtorrt";
    return "Torrt";
  };

  const potentialABV = calculatePotentialABV();
  const currentABV = calculateCurrentABV();
  const attenuation = calculateAttenuation();
  const sweetness = getSweetnessStatus();

  // --- GRAF-DATA ---
  const getGraphData = () => {
    const dataPoints = [];
    
    if (og > 0 && startDate) {
      dataPoints.push({
        date: new Date(startDate).getTime(),
        displayDate: startDate.substring(5),
        value: parseFloat(og),
        type: 'start'
      });
    }

    const regex = /- (\d{4}\/\d{2}\/\d{2}):\s*(-?\d+)\s*°Oe/g;
    let match;
    while ((match = regex.exec(log)) !== null) {
      const dateStr = match[1].replace(/\//g, '-');
      const val = parseFloat(match[2]);
      if (!isNaN(val)) {
        dataPoints.push({
          date: new Date(dateStr).getTime(),
          displayDate: dateStr.substring(5),
          value: val,
          type: 'log'
        });
      }
    }
    return dataPoints.sort((a, b) => a.date - b.date);
  };

  const graphData = getGraphData();

  // --- LOGG & PÅMINNELSE ---

  const handleAddLogEntry = () => {
    const today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
    const newEntry = `- ${today}: ${fg} °Oe, ${currentABV}% ABV (${attenuation}% utjäst)\n`;
    setLog(prevLog => {
      const prefix = (prevLog.length > 0 && !prevLog.endsWith('\n')) ? '\n' : '';
      return prevLog + prefix + newEntry;
    });
  };

  const handleAddDateOnly = () => {
    const today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
    const newEntry = `- ${today}: `;
    setLog(prevLog => {
      const prefix = (prevLog.length > 0 && !prevLog.endsWith('\n')) ? '\n' : '';
      return prevLog + prefix + newEntry;
    });
  };

  const reminderOptions = {
    measure: { label: 'Mät Gravity', desc: 'Dags att mäta Öchsle och uppdatera loggen.' },
    rack: { label: 'Tappa om', desc: 'Dags att tappa om (racka) mjödet till ett nytt kärl.' },
    feed: { label: 'Tillsätt näring', desc: 'Dags att tillsätta jästnäring.' },
    sweeten: { label: 'Eftersöta', desc: 'Dags att stabilisera och eftersöta mjödet.' },
    bottle: { label: 'Buteljera', desc: 'Dags att tappa upp mjödet på flaskor.' }
  };

  const handleCreateReminder = (days) => {
    const date = new Date();
    date.setDate(date.getDate() + days);
    date.setHours(18, 0, 0, 0);
    
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    const dateStr = `${year}${month}${day}T${hours}${minutes}${seconds}`;
    
    const cleanName = batchName.trim() || 'Mjöd';
    const typeInfo = reminderOptions[reminderType];

    const icsContent = [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'PRODID:-//Mjödbryggning//App//SV',
      'BEGIN:VEVENT',
      `UID:${Date.now()}@mjodbryggning.app`,
      `DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z`,
      `DTSTART:${dateStr}`,
      `SUMMARY:${typeInfo.label}: ${cleanName}`,
      `DESCRIPTION:${typeInfo.desc} (Batch: ${cleanName})`,
      'END:VEVENT',
      'END:VCALENDAR'
    ].join('\r\n');

    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `paminnelse-${typeInfo.label.toLowerCase()}-${cleanName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.ics`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    setShowReminderMenu(false);
  };

  const handleFillTestData = () => {
    setBatchName("Testmjöd (Viking Blod)");
    const today = new Date();
    const start = new Date(today);
    start.setDate(today.getDate() - 30);
    const startStr = start.toISOString().split('T')[0];
    setStartDate(startStr);
    setIngredients("3.5 kg Honung (Ljung)\n10 l Vatten\n50g Hibiskusblommor\nJäst: Lalvin D-47\nJästnäring: Fermaid O");
    setOg(110);
    setOgTemp(20);
    setFg(2);
    setFgTemp(20);
    setCurrentBatchId(null); 

    let testLog = "";
    const points = [
        { day: 0, val: 110 },
        { day: 3, val: 95 },
        { day: 7, val: 60 },
        { day: 14, val: 20 },
        { day: 21, val: 5 },
        { day: 30, val: 2 } 
    ];

    points.forEach(p => {
        const d = new Date(start);
        d.setDate(d.getDate() + p.day);
        const dateStr = d.toISOString().split('T')[0].replace(/-/g, '/');
        const att = Math.max(0, Math.min(100, ((110 - p.val) / 110) * 100)).toFixed(1);
        const abv = Math.max(0, (110 - p.val) / 7.5).toFixed(1);
        testLog += `- ${dateStr}: ${p.val} °Oe, ${abv}% ABV (${att}% utjäst)\n`;
    });

    setLog(testLog);
    setNameError(false);
  };

  // --- CRUD OPERATIONS ---

  const handleSaveBatch = async () => {
    if (!batchName.trim()) {
      setNameError(true); 
      return;
    }
    if (!user) {
        alert("Du är inte ansluten till databasen än. Vänta lite...");
        return;
    }

    setNameError(false);

    const batchData = {
      name: batchName,
      startDate: startDate, 
      lastModified: new Date().toLocaleDateString('sv-SE'),
      ingredients,
      log,
      og,
      ogTemp,
      fg,
      fgTemp
    };

    try {
      if (currentBatchId) {
        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'batches', currentBatchId.toString());
        await setDoc(docRef, batchData, { merge: true });
      } else {
        const newId = Date.now();
        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'batches', newId.toString());
        await setDoc(docRef, batchData);
        setCurrentBatchId(newId);
      }
      // Stäng menyn efter sparning om man vill? Nej, låt den vara.
    } catch (error) {
      console.error("Fel vid sparande:", error);
      alert("Kunde inte spara till molnet.");
    }
  };

  const handleLoadBatch = (batch) => {
    setCurrentBatchId(batch.id);
    setBatchName(batch.name);
    setStartDate(batch.startDate || new Date().toISOString().split('T')[0]);
    setIngredients(batch.ingredients);
    setLog(batch.log || '');
    setOg(batch.og);
    setOgTemp(batch.ogTemp);
    setFg(batch.fg);
    setFgTemp(batch.fgTemp);
    setNameError(false);
    setShowBatchMenu(false); // Stäng menyn efter laddning
  };

  const handleNewBatch = () => {
    setCurrentBatchId(null);
    setBatchName('');
    setStartDate(new Date().toISOString().split('T')[0]);
    setIngredients('');
    setLog('');
    setOg(0);
    setOgTemp(20);
    setFg(0);
    setFgTemp(20);
    setNameError(false);
    setShowBatchMenu(false); // Stäng menyn
  };

  const initiateDeleteBatch = (e, id) => {
    e.stopPropagation();
    setBatchToDelete(id);
    setShowDeleteModal(true);
  };

  const confirmDeleteBatch = async () => {
    if (batchToDelete && user) {
      try {
        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'batches', batchToDelete.toString());
        await deleteDoc(docRef);
        
        if (currentBatchId === batchToDelete) {
          handleNewBatch();
        }
        setShowDeleteModal(false);
        setBatchToDelete(null);
      } catch (error) {
        console.error("Fel vid radering:", error);
        alert("Kunde inte ta bort batchen.");
      }
    }
  };

  const handleExportData = () => {
    if (savedBatches.length === 0) {
      alert("Det finns inga sparade batcher att exportera.");
      return;
    }
    const dataStr = JSON.stringify(savedBatches, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `batch-builder-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  const handleImportClick = () => {
    fileInputRef.current.click();
  };

  const handleFileChange = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const importedData = JSON.parse(e.target.result);
        if (Array.isArray(importedData) && user) {
            let importCount = 0;
            const existingIds = new Set(savedBatches.map(b => b.id));
            
            for (const batch of importedData) {
              if (!existingIds.has(batch.id)) {
                const newId = Date.now() + Math.floor(Math.random() * 10000); 
                const { id, ...dataToSave } = batch;
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'batches', newId.toString());
                await setDoc(docRef, dataToSave);
                importCount++;
              }
            }
            if (importCount > 0) alert(`Lyckades importera ${importCount} batcher till molnet!`);
            else alert("Inga nya batcher hittades.");
        }
      } catch (error) {
        console.error("Import error", error);
        alert("Något gick fel vid importen.");
      }
    };
    reader.readAsText(file);
    event.target.value = ''; 
  };

  const oechsleOptions = Array.from({ length: 136 }, (_, i) => i - 15);

  return (
    <div 
      className="min-h-screen flex flex-col bg-slate-900 text-orange-100 font-sans selection:bg-orange-500/30 relative overflow-hidden"
      style={{ backgroundColor: '#0f172a', color: '#ffedd5' }} // Fallback styles
    >
      
      {/* DELETE CONFIRMATION MODAL */}
      {showDeleteModal && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-950/70 backdrop-blur-sm" onClick={() => setShowDeleteModal(false)}>
          <div className="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100" onClick={e => e.stopPropagation()}>
            <div className="flex items-center gap-3 mb-4 text-orange-400">
              <Trash2 size={24} />
              <h3 className="text-lg font-bold">Ta bort batch?</h3>
            </div>
            <p className="text-slate-300 text-sm mb-6 leading-relaxed">
              Är du säker på att du vill ta bort denna batch? Detta går inte att ångra och den raderas från molnet.
            </p>
            <div className="flex gap-3 justify-end">
              <button 
                onClick={() => setShowDeleteModal(false)}
                className="px-4 py-2 rounded-lg text-slate-300 hover:text-white hover:bg-slate-700 transition-colors text-sm font-medium"
              >
                Avbryt
              </button>
              <button 
                onClick={confirmDeleteBatch}
                className="px-4 py-2 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 border border-red-500/20 hover:border-red-500/40 transition-all text-sm font-medium shadow-lg shadow-red-900/10"
              >
                Ta bort
              </button>
            </div>
          </div>
        </div>
      )}

      {/* INFO MODAL */}
      {showInfo && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-950/70 backdrop-blur-sm" onClick={() => setShowInfo(false)}>
          <div className="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto custom-scrollbar" onClick={e => e.stopPropagation()}>
            <div className="flex items-center justify-between p-6 border-b border-slate-700">
              <h2 className="text-xl font-bold text-orange-400 flex items-center gap-2">
                <Info size={24} />
                Mjödbryggning & App-guide
              </h2>
              <button onClick={() => setShowInfo(false)} className="text-slate-400 hover:text-orange-300 transition-colors">
                <X size={24} />
              </button>
            </div>
            <div className="p-6 text-slate-300 space-y-6 text-sm leading-relaxed">
              <section>
                <h3 className="text-orange-200 font-bold uppercase tracking-wider mb-3 text-xs border-b border-slate-700 pb-1">Hur man använder appen</h3>
                <ul className="list-disc pl-5 space-y-2">
                   <li><strong className="text-orange-100">Batcher:</strong> Klicka på <FolderOpen size={14} className="inline mx-1"/> högst upp för att se dina sparade batcher eller skapa en ny.</li>
                  <li><strong className="text-orange-100">Molnlagring:</strong> Dina batcher sparas nu automatiskt i molnet (Firebase) när du klickar på "Spara". Du kan komma åt dem från vilken enhet som helst om du använder samma inloggning.</li>
                  <li><strong className="text-orange-100">Verktyg:</strong> Här matar du in all data. Fyll i namn, datum, ingredienser och mätvärden.</li>
                  <li><strong className="text-orange-100">Logg:</strong> Använd den lilla <Save size={12} className="inline mx-1"/> ikonen vid FG för att snabbt spara dagens mätvärde till loggen.</li>
                </ul>
              </section>
              {/* ... Resten av info ... */}
              <section>
                <h3 className="text-orange-200 font-bold uppercase tracking-wider mb-3 text-xs border-b border-slate-700 pb-1">Att mäta Öchsle (°Oe)</h3>
                <div className="space-y-3">
                  <p>Tips: Rent vatten har 0 °Oe. Socker gör vätskan tyngre (plusvärde). Alkohol gör vätskan lättare (kan ge minusvärde vid torrt mjöd).</p>
                </div>
              </section>
            </div>
          </div>
        </div>
      )}

      {/* Dold filväljare för import */}
      <input 
        type="file" 
        ref={fileInputRef}
        onChange={handleFileChange}
        accept=".json"
        className="hidden" 
      />

      {/* Header */}
      <header className="flex-none p-4 border-b border-slate-800 flex items-center justify-between z-10 bg-slate-900 sticky top-0 backdrop-blur-md bg-slate-900/90 shadow-sm">
        <div className="flex items-center gap-3">
          <h1 className="text-xl font-bold tracking-tight text-orange-400">
            Mjödbryggning
          </h1>
          <span 
            onClick={handleFillTestData}
            className="text-[10px] font-mono text-orange-200/40 border border-orange-500/20 px-1.5 py-0.5 rounded cursor-pointer hover:bg-orange-500/10 hover:text-orange-200 transition-colors"
            title="Klicka för att ladda testdata"
          >
            v1.0.0
          </span>
          <button 
            onClick={() => setShowInfo(true)}
            className="ml-2 text-slate-500 hover:text-orange-400 transition-colors p-1 rounded-full hover:bg-slate-800"
            title="Visa instruktioner"
          >
            <Info size={18} />
          </button>
        </div>

        <div className="flex items-center gap-2">
           {/* BATCH MENU DROPDOWN */}
           <div className="relative" ref={batchMenuRef}>
            <button 
              onClick={() => setShowBatchMenu(!showBatchMenu)}
              className={`flex items-center gap-2 px-3 py-1.5 rounded-lg transition-all border border-transparent group ${showBatchMenu ? 'bg-orange-500/10 text-orange-400 border-orange-500/30' : 'text-slate-400 hover:text-orange-300 hover:bg-slate-800 hover:border-slate-700'}`}
              title="Mina Batcher"
            >
              <FolderOpen size={16} className="group-hover:-translate-y-0.5 transition-transform" />
              <span className="text-xs font-medium">Mina Batcher</span>
              <ChevronDown size={14} className={`transition-transform duration-200 ${showBatchMenu ? 'rotate-180' : ''}`}/>
            </button>

            {/* DROPDOWN CONTENT */}
            {showBatchMenu && (
              <div className="absolute right-0 top-full mt-2 w-80 max-h-[80vh] bg-slate-900 border border-slate-700 rounded-xl shadow-2xl z-50 flex flex-col overflow-hidden animate-in fade-in zoom-in-95 duration-100 origin-top-right">
                <div className="p-3 border-b border-slate-800 flex-none bg-slate-900/95 backdrop-blur">
                  <button 
                    onClick={handleNewBatch}
                    className="w-full py-2 border-2 border-dashed border-slate-700 rounded-lg text-slate-400 hover:text-orange-300 hover:border-orange-500/40 hover:bg-slate-800 transition-all flex items-center justify-center gap-2 group"
                  >
                    <Plus size={16} className="group-hover:scale-110 transition-transform"/>
                    <span className="text-xs font-bold uppercase tracking-wider">Skapa Ny Batch</span>
                  </button>
                </div>
                
                <div className="overflow-y-auto custom-scrollbar flex-1 p-2 space-y-2 bg-slate-900/50">
                  {savedBatches.length === 0 ? (
                    <div className="text-center py-6 px-4 text-slate-600 text-xs italic">
                      Inga sparade batcher än.
                    </div>
                  ) : (
                    savedBatches.map((batch) => (
                      <div 
                        key={batch.id} 
                        onClick={() => handleLoadBatch(batch)}
                        className={`p-3 rounded-lg border transition-all group cursor-pointer relative ${currentBatchId === batch.id ? 'bg-orange-500/10 border-orange-500/40' : 'bg-slate-800/50 border-slate-800 hover:border-slate-600 hover:bg-slate-800'}`}
                      >
                        <div className="flex justify-between items-start mb-2">
                          <h4 className={`font-medium text-sm truncate pr-6 ${currentBatchId === batch.id ? 'text-orange-300' : 'text-slate-300 group-hover:text-orange-200'}`}>{batch.name}</h4>
                          <button 
                            onClick={(e) => initiateDeleteBatch(e, batch.id)}
                            className="text-slate-600 hover:text-red-400 transition-colors p-1 hover:bg-slate-900 rounded absolute top-2 right-2"
                            title="Ta bort"
                          >
                            <Trash2 size={14} />
                          </button>
                        </div>
                        <div className="flex justify-between text-[10px] text-slate-500 font-mono">
                          <span>OG: <span className="text-slate-400">{batch.og}</span></span>
                          <span>Start: {batch.startDate} ({getDaysSince(batch.startDate)}d)</span>
                        </div>
                      </div>
                    ))
                  )}
                </div>
                
                {/* Footer with actions */}
                <div className="p-2 border-t border-slate-800 bg-slate-950/50 flex justify-between gap-2 text-[10px] text-slate-500">
                    <button onClick={handleImportClick} className="hover:text-orange-300 flex items-center gap-1"><Upload size={12}/> Importera</button>
                    <button onClick={handleExportData} className="hover:text-orange-300 flex items-center gap-1"><Download size={12}/> Exportera</button>
                </div>
              </div>
            )}
          </div>
          
          <div className="h-5 w-px bg-slate-800 mx-1"></div>
          
          <button 
            onClick={handleSaveBatch}
            className="flex items-center gap-2 px-3 py-1.5 rounded-lg text-orange-400 hover:text-orange-300 hover:bg-orange-500/10 transition-all border border-orange-500/20 hover:border-orange-500/40 shadow-lg shadow-orange-900/20 group active:scale-95"
            title="Spara projekt till listan (Molnet)"
          >
            <Save size={16} className="group-hover:scale-110 transition-transform" />
            <span className="text-xs font-medium">Spara</span>
          </button>
        </div>
      </header>

      {/* Main Content - Now centered single column */}
      <main className="flex-1 p-4 overflow-y-auto custom-scrollbar">
        <div className="max-w-2xl mx-auto space-y-4 pb-10">

          {/* Verktyg (Interaktion) */}
          <section className="bg-slate-800 rounded-xl p-4 border border-slate-700 shadow-xl flex flex-col relative">
            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-500/0 via-orange-500/50 to-orange-500/0"></div>
            
            <div className="flex items-center gap-2 mb-4 border-b border-orange-500/20 pb-3">
              <div className="p-1.5 bg-orange-500/10 rounded-md text-orange-400">
                <Wrench size={16} />
              </div>
              <h2 className="text-sm font-semibold text-orange-300 uppercase tracking-wider">Verktyg</h2>
            </div>

            <div className="flex flex-col gap-3">
              {/* Batchens namn */}
              <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Batchens namn</label>
                <input 
                  type="text"
                  value={batchName}
                  onChange={(e) => setBatchName(e.target.value)}
                  placeholder="Skriv in namn på batchen..."
                  className={`w-full bg-slate-950/50 border rounded-md px-3 py-2 text-sm text-orange-100 placeholder-slate-600 focus:outline-none focus:ring-1 transition-all font-medium ${nameError ? 'border-red-500/50 focus:border-red-500 focus:ring-red-500/50 animate-pulse' : 'border-slate-700 focus:border-orange-500/50 focus:ring-orange-500/50'}`}
                />
              </div>

              {/* Startdatum */}
              <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Startdatum</label>
                <div className="relative">
                  <input 
                    type="date"
                    value={startDate}
                    onChange={(e) => setStartDate(e.target.value)}
                    className="w-full bg-slate-950/50 border border-slate-700 rounded-md px-3 py-2 text-sm text-orange-100 placeholder-slate-600 focus:outline-none focus:border-orange-500/50 focus:ring-1 focus:ring-orange-500/50 transition-all font-medium appearance-none [color-scheme:dark]"
                  />
                  <div className="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-orange-400/70">
                    <Calendar size={14} />
                  </div>
                </div>
              </div>

              {/* Ingredienser */}
              <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Ingredienser</label>
                <textarea 
                  rows={5}
                  value={ingredients}
                  onChange={(e) => setIngredients(e.target.value)}
                  placeholder="Lista dina ingredienser här..."
                  className="w-full bg-slate-950/50 border border-slate-700 rounded-md px-3 py-2 text-sm text-orange-100 placeholder-slate-600 focus:outline-none focus:border-orange-500/50 focus:ring-1 focus:ring-orange-500/50 transition-all font-medium resize-none custom-scrollbar"
                />
              </div>

              {/* Original Gravity Section */}
              <div className="space-y-1">
                <div className="flex items-center gap-2 mb-1">
                  <div className="h-px flex-1 bg-slate-700/50"></div>
                  <span className="text-[10px] font-bold text-orange-400/50 uppercase tracking-wider">Original Gravity</span>
                  <div className="h-px flex-1 bg-slate-700/50"></div>
                </div>
                
                <div className="flex gap-3">
                  {/* OG - Öchsle */}
                  <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 w-1/3">
                    <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Öchsle (°Oe)</label>
                    <div className="relative">
                      <select 
                        value={og}
                        onChange={(e) => setOg(e.target.value)}
                        className="w-full bg-slate-950/50 border border-slate-700 rounded-md pl-3 pr-8 py-2 text-sm text-orange-100 focus:outline-none focus:border-orange-500/50 focus:ring-1 focus:ring-orange-500/50 transition-all font-medium appearance-none cursor-pointer hover:bg-slate-900"
                      >
                        {oechsleOptions.map((val) => (
                          <option key={val} value={val} className="bg-slate-900">{val}</option>
                        ))}
                      </select>
                      <div className="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-orange-400/70">
                        <ChevronDown size={14} />
                      </div>
                    </div>
                  </div>

                  {/* OG - Temperatur */}
                  <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 w-1/3">
                    <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Temperatur (°C)</label>
                    <input 
                      type="number" 
                      value={ogTemp}
                      onChange={(e) => setOgTemp(e.target.value)}
                      placeholder="20"
                      className="w-full bg-slate-950/50 border border-slate-700 rounded-md px-3 py-2 text-sm text-orange-100 placeholder-slate-600 focus:outline-none focus:border-orange-500/50 focus:ring-1 focus:ring-orange-500/50 transition-all font-medium appearance-none"
                    />
                  </div>

                  {/* OG - Potentiell ABV */}
                  <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 w-1/3 flex flex-col justify-center relative overflow-hidden group">
                    <div className="absolute top-0 right-0 p-1 opacity-10 group-hover:opacity-20 transition-opacity">
                      <Activity size={32} className="text-orange-500" />
                    </div>
                    <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Potentiell ABV</label>
                    <div className="flex items-baseline gap-1">
                      <span className="text-2xl font-bold text-orange-400 tracking-tight">{potentialABV}</span>
                      <span className="text-xs font-medium text-orange-500/60">%</span>
                    </div>
                  </div>
                </div>
              </div>

              {/* Aktuell/Final Gravity Section */}
              <div className="space-y-1">
                <div className="flex items-center gap-2 mb-1">
                  <div className="h-px flex-1 bg-slate-700/50"></div>
                  <span className="text-[10px] font-bold text-orange-400/50 uppercase tracking-wider">Aktuell / Final Gravity</span>
                  {/* Spara-knapp för logg */}
                  <button 
                    onClick={handleAddLogEntry}
                    className="flex items-center justify-center p-1 rounded hover:bg-orange-500/20 text-orange-400 transition-colors"
                    title="Spara mätvärde till logg"
                  >
                    <Save size={14} />
                  </button>
                  <div className="h-px flex-1 bg-slate-700/50"></div>
                </div>

                <div className="flex gap-3">
                  {/* FG - Öchsle */}
                  <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 w-1/3">
                    <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Öchsle (°Oe)</label>
                    <div className="relative">
                      <select 
                        value={fg}
                        onChange={(e) => setFg(e.target.value)}
                        className="w-full bg-slate-950/50 border border-slate-700 rounded-md pl-3 pr-8 py-2 text-sm text-orange-100 focus:outline-none focus:border-orange-500/50 focus:ring-1 focus:ring-orange-500/50 transition-all font-medium appearance-none cursor-pointer hover:bg-slate-900"
                      >
                         {oechsleOptions.map((val) => (
                          <option key={val} value={val} className="bg-slate-900">{val}</option>
                        ))}
                      </select>
                      <div className="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-orange-400/70">
                        <ChevronDown size={14} />
                      </div>
                    </div>
                  </div>

                  {/* FG - Temperatur */}
                  <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 w-1/3">
                    <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Temperatur (°C)</label>
                    <input 
                      type="number" 
                      value={fgTemp}
                      onChange={(e) => setFgTemp(e.target.value)}
                      placeholder="20"
                      className="w-full bg-slate-950/50 border border-slate-700 rounded-md px-3 py-2 text-sm text-orange-100 placeholder-slate-600 focus:outline-none focus:border-orange-500/50 focus:ring-1 focus:ring-orange-500/50 transition-all font-medium appearance-none"
                    />
                  </div>

                  {/* FG - Aktuell ABV */}
                  <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 w-1/3 flex flex-col justify-center relative overflow-hidden group">
                    <div className="absolute top-0 right-0 p-1 opacity-10 group-hover:opacity-20 transition-opacity">
                      <Droplets size={32} className="text-orange-500" />
                    </div>
                    <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Aktuell ABV</label>
                    <div className="flex items-baseline gap-1">
                      <span className="text-2xl font-bold text-orange-400 tracking-tight">{currentABV}</span>
                      <span className="text-xs font-medium text-orange-500/60">%</span>
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Utjäsning */}
              <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                <div className="space-y-2">
                  <div>
                    <div className="flex justify-between text-[10px] mb-1.5">
                      <span className="text-orange-200 uppercase font-bold opacity-70">Utjäsning (Beräknad)</span>
                      <div className="flex gap-2">
                        <span className="text-orange-300 italic">{sweetness}</span>
                        <span className="text-orange-400 font-mono border-l border-slate-700 pl-2">{attenuation}%</span>
                      </div>
                    </div>
                    <div className="h-1.5 bg-slate-700 rounded-full overflow-hidden">
                      <div 
                        className="h-full rounded-full transition-all duration-500"
                        style={{ 
                          width: `${Math.min(attenuation, 100)}%`,
                          // Dynamisk färgskala: Orange (30) till Grön (120) baserat på %
                          backgroundColor: `hsl(${30 + (Math.min(parseFloat(attenuation) || 0, 100) * 0.9)}, 90%, 50%)`
                        }}
                      ></div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Logg - Nu i egen box, med extern rubrik */}
              <div className="space-y-1 relative">
                <div className="flex items-center gap-2 mb-1">
                  <div className="h-px flex-1 bg-slate-700/50"></div>
                  
                  {/* Header med Logg text och ikoner */}
                  <div className="flex items-center gap-3">
                    <button 
                      onClick={handleAddDateOnly}
                      className="flex items-center gap-1 group hover:bg-orange-500/10 px-2 py-0.5 rounded transition-colors"
                      title="Klicka för att infoga dagens datum"
                    >
                      <FileText size={12} className="text-orange-400/50 group-hover:text-orange-400 transition-colors" />
                      <span className="text-[10px] font-bold text-orange-400/50 group-hover:text-orange-400 uppercase tracking-wider transition-colors">Logg</span>
                    </button>

                    {/* PÅMINNELSE-KNAPP */}
                    <div className="relative">
                      <button 
                        onClick={() => setShowReminderMenu(!showReminderMenu)}
                        className={`flex items-center gap-1 group hover:bg-orange-500/10 px-1.5 py-0.5 rounded transition-colors ${showReminderMenu ? 'bg-orange-500/10 text-orange-400' : 'text-orange-400/50'}`}
                        title="Skapa påminnelse i kalendern"
                      >
                        <Bell size={12} className={`group-hover:text-orange-400 transition-colors ${showReminderMenu ? 'text-orange-400' : ''}`} />
                      </button>
                      
                      {/* PÅMINNELSE MENY - UPDATERAD */}
                      {showReminderMenu && (
                        <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 bg-slate-800 border border-slate-700 rounded-lg shadow-xl p-2 flex flex-col gap-2 w-48 z-20">
                          
                          {/* Välj aktivitetstyp */}
                          <div className="px-1">
                            <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Aktivitet</label>
                            <select 
                              value={reminderType}
                              onChange={(e) => setReminderType(e.target.value)}
                              className="w-full bg-slate-900 border border-slate-600 rounded text-xs text-slate-300 p-1 focus:outline-none focus:border-orange-500"
                            >
                              <option value="measure">Mät Gravity</option>
                              <option value="rack">Tappa om</option>
                              <option value="feed">Tillsätt näring</option>
                              <option value="sweeten">Eftersöta</option>
                              <option value="bottle">Buteljera</option>
                            </select>
                          </div>

                          <div className="h-px bg-slate-700 my-0.5"></div>

                          {/* Välj tid */}
                          <div className="flex flex-col gap-1">
                            <label className="text-[10px] font-bold text-orange-400/70 uppercase px-1">När?</label>
                            {reminderType === 'feed' ? (
                              <>
                                <button onClick={() => handleCreateReminder(1)} className="text-[10px] text-left px-2 py-1.5 hover:bg-slate-700 rounded text-slate-300 hover:text-orange-200">Om 24 timmar (Dag 1)</button>
                                <button onClick={() => handleCreateReminder(2)} className="text-[10px] text-left px-2 py-1.5 hover:bg-slate-700 rounded text-slate-300 hover:text-orange-200">Om 48 timmar (Dag 2)</button>
                                <button onClick={() => handleCreateReminder(3)} className="text-[10px] text-left px-2 py-1.5 hover:bg-slate-700 rounded text-slate-300 hover:text-orange-200">Om 72 timmar (Dag 3)</button>
                                <button onClick={() => handleCreateReminder(7)} className="text-[10px] text-left px-2 py-1.5 hover:bg-slate-700 rounded text-slate-300 hover:text-orange-200">Om 1 vecka (Dag 7)</button>
                              </>
                            ) : (
                              <>
                                <button onClick={() => handleCreateReminder(3)} className="text-[10px] text-left px-2 py-1.5 hover:bg-slate-700 rounded text-slate-300 hover:text-orange-200">Om 3 dagar</button>
                                <button onClick={() => handleCreateReminder(7)} className="text-[10px] text-left px-2 py-1.5 hover:bg-slate-700 rounded text-slate-300 hover:text-orange-200">Om 1 vecka</button>
                                <button onClick={() => handleCreateReminder(14)} className="text-[10px] text-left px-2 py-1.5 hover:bg-slate-700 rounded text-slate-300 hover:text-orange-200">Om 2 veckor</button>
                                <button onClick={() => handleCreateReminder(30)} className="text-[10px] text-left px-2 py-1.5 hover:bg-slate-700 rounded text-slate-300 hover:text-orange-200">Om 1 månad</button>
                              </>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="h-px flex-1 bg-slate-700/50"></div>
                </div>
                
                <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                  <textarea 
                    rows={5}
                    value={log}
                    onChange={(e) => setLog(e.target.value)}
                    placeholder="Här sparas dina mätningar, men du kan också skriva egna anteckningar..."
                    className="w-full bg-slate-950/50 border border-slate-700 rounded-md px-3 py-2 text-sm text-orange-100 placeholder-slate-600 focus:outline-none focus:border-orange-500/50 focus:ring-1 focus:ring-orange-500/50 transition-all font-medium resize-none custom-scrollbar font-mono leading-relaxed mb-3"
                  />

                  {/* GRAF */}
                  {graphData.length > 1 && (
                    <div className="mt-2 pt-2 border-t border-slate-700/50">
                      <div className="flex items-center gap-2 mb-2 text-orange-400/50">
                        <TrendingDown size={12} />
                        <span className="text-[10px] uppercase font-bold tracking-wider">Jäskurva</span>
                      </div>
                      
                      <div className="h-24 w-full flex items-end justify-between gap-1 px-1 relative">
                        {/* Enkel SVG Graf */}
                        <svg className="absolute inset-0 w-full h-full overflow-visible" viewBox="0 0 100 100" preserveAspectRatio="none">
                            {/* Stödlinjer (Grid) - Horisontella */}
                            {[0, 25, 50, 75, 100].map((lineY) => (
                                <line 
                                    key={`h-${lineY}`}
                                    x1="0" y1={lineY} 
                                    x2="100" y2={lineY} 
                                    stroke="rgba(148, 163, 184, 0.1)" 
                                    strokeWidth="1"
                                    vectorEffect="non-scaling-stroke"
                                />
                            ))}

                            {/* Stödlinjer (Grid) - Vertikala (vid datapunkter) */}
                            {graphData.map((_, i) => {
                                const x = (i / (graphData.length - 1)) * 100;
                                return (
                                    <line 
                                        key={`v-${i}`}
                                        x1={x} y1="0" 
                                        x2={x} y2="100" 
                                        stroke="rgba(148, 163, 184, 0.1)" 
                                        strokeWidth="1"
                                        vectorEffect="non-scaling-stroke"
                                    />
                                )
                            })}

                          <path 
                            d={`M ${graphData.map((pt, i) => {
                              // X: Procent av bredden
                              const x = (i / (graphData.length - 1)) * 100;
                              // Y: Normalisera värde mellan min och max (inverterat för graf)
                              const maxVal = Math.max(...graphData.map(d => d.value)) + 5;
                              const minVal = Math.min(...graphData.map(d => d.value)) - 5;
                              const range = maxVal - minVal;
                              const y = 100 - ((pt.value - minVal) / range * 100);
                              return `${x} ${y}`;
                            }).join(' L ')}`}
                            fill="none" 
                            stroke="rgba(251, 146, 60, 0.6)" 
                            strokeWidth="2"
                            strokeDasharray="4 4"
                            vectorEffect="non-scaling-stroke"
                          />
                        </svg>
                        
                        {/* Punkter (DOM Element ovanpå SVG) */}
                        {graphData.map((pt, i) => {
                             const x = (i / (graphData.length - 1)) * 100;
                             const maxVal = Math.max(...graphData.map(d => d.value)) + 5;
                             const minVal = Math.min(...graphData.map(d => d.value)) - 5;
                             const range = maxVal - minVal;
                             const y = 100 - ((pt.value - minVal) / range * 100);
                             return (
                               <div 
                                key={i}
                                className={`absolute w-1.5 h-1.5 rounded-full -ml-[3px] -mt-[3px] border border-orange-400 ${pt.type === 'start' ? 'bg-slate-900' : 'bg-orange-400'}`}
                                style={{ left: `${x}%`, top: `${y}%` }}
                               />
                             );
                          })}
                        
                        {/* Datum etiketter (bara första och sista om många) */}
                        {graphData.map((pt, i) => {
                           if (i === 0 || i === graphData.length - 1 || (graphData.length < 6) || (i % Math.ceil(graphData.length/4) === 0)) {
                               return (
                                 <div key={i} className="text-[8px] text-slate-500 absolute -bottom-4 transform -translate-x-1/2 whitespace-nowrap" style={{ left: `${(i / (graphData.length - 1)) * 100}%` }}>
                                   {pt.displayDate}
                                 </div>
                               )
                           }
                           return null;
                        })}
                      </div>
                      <div className="h-4"></div> {/* Spacer för datum */}
                    </div>
                  )}
                </div>
              </div>

            </div>
          </section>

        </div>
      </main>

      <style>{`
        .custom-scrollbar::-webkit-scrollbar {
          width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: rgba(30, 41, 59, 0.5); 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: rgba(251, 146, 60, 0.2); 
          border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background: rgba(251, 146, 60, 0.4); 
        }
      `}</style>
    </div>
  );
}
