<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mjödbryggning Pro</title>
    
    <!-- 1. Hämta designmotorn (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Hämta React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Hämta Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Hämta Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #0f172a; color: #ffedd5; font-family: ui-sans-serif, system-ui, sans-serif; margin: 0; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(251, 146, 60, 0.2); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(251, 146, 60, 0.4); }
        .saving-pulse { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- IKONER ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                Wrench: <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />,
                Archive: <><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></>,
                Plus: <path d="M5 12h14M12 5v14"/>,
                Save: <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2zM17 21v-8H7v8M7 3v5h8"/>,
                Activity: <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>,
                Droplets: <><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.8-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"/></>,
                Trash2: <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"/>,
                Calendar: <><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>,
                FileText: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>,
                Info: <><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></>,
                X: <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>,
                TrendingDown: <><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></>,
                Bell: <><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></>,
                ChevronDown: <path d="m6 9 6 6 6-6"/>,
                FolderOpen: <path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H18a2 2 0 0 1 2 2v2"/>,
                LogIn: <><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></>,
                LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>,
                User: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
                AlertTriangle: <><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></>,
                Download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>,
                Upload: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        // --- FIREBASE KONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDGmN-60JoFMFyKNtEVR4sRf258GTv2jU4",
            authDomain: "mjodbryggning.firebaseapp.com",
            projectId: "mjodbryggning",
            storageBucket: "mjodbryggning.firebasestorage.app",
            messagingSenderId: "795065616004",
            appId: "1:795065616004:web:27f329729112c0f09fa4d1",
            measurementId: "G-1GDMF1NNQ4"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "mjodbryggning-live"; 

        function App() {
            // STATE
            const [user, setUser] = useState(null);
            const [isOffline, setIsOffline] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [currentBatchId, setCurrentBatchId] = useState(null);
            const [showInfo, setShowInfo] = useState(false);
            const [showBatchMenu, setShowBatchMenu] = useState(false);
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [showNewBatchConfirm, setShowNewBatchConfirm] = useState(false); 
            const [batchToDelete, setBatchToDelete] = useState(null);
            const [showReminderMenu, setShowReminderMenu] = useState(false);
            const [reminderType, setReminderType] = useState('measure');
            const [nameError, setNameError] = useState(false);
            
            // DATA STATE
            const [batchName, setBatchName] = useState('');
            const [startDate, setStartDate] = useState(new Date().toISOString().split('T')[0]);
            const [ingredients, setIngredients] = useState('');
            const [log, setLog] = useState('');
            const [og, setOg] = useState(0);
            const [ogTemp, setOgTemp] = useState(20);
            const [fg, setFg] = useState(0);
            const [fgTemp, setFgTemp] = useState(20);
            const [savedBatches, setSavedBatches] = useState([]);

            const fileInputRef = useRef(null);
            const batchMenuRef = useRef(null);

            // --- HJÄLPFUNKTIONER ---
            const getCorrectedGravity = (g, t) => {
                const grav = parseFloat(g);
                const temp = parseFloat(t);
                if (isNaN(grav) || isNaN(temp)) return 0;
                return grav + ((temp - 20) * 0.2);
            };

            const calculatePotentialABV = () => Math.max(0, getCorrectedGravity(og, ogTemp) / 7.5).toFixed(1);
            const calculateCurrentABV = () => {
                const cOG = getCorrectedGravity(og, ogTemp);
                const cFG = getCorrectedGravity(fg, fgTemp);
                if (cOG <= 0) return "0.0";
                return Math.max(0, (cOG - cFG) / 7.5).toFixed(1);
            };
            const calculateAttenuation = () => {
                const cOG = getCorrectedGravity(og, ogTemp);
                const cFG = getCorrectedGravity(fg, fgTemp);
                if (cOG <= 0) return "0.0";
                return Math.max(0, Math.min(100, ((cOG - cFG) / cOG) * 100)).toFixed(1);
            };
            const getSweetnessStatus = () => {
                const cFG = getCorrectedGravity(fg, fgTemp);
                if (og == 0 && fg == 0) return "-";
                if (cFG >= 45) return "Dessert / Mycket sött";
                if (cFG >= 25) return "Sött";
                if (cFG >= 12) return "Halvsött";
                if (cFG >= 4) return "Halvtorrt";
                return "Torrt";
            };
            const getDaysSince = (d) => {
                if (!d) return 0;
                const start = new Date(d); const today = new Date();
                start.setHours(0,0,0,0); today.setHours(0,0,0,0);
                return Math.max(0, Math.floor((today - start) / (1000 * 60 * 60 * 24)));
            };
            const getGraphData = () => {
                const dataPoints = [];
                if (og > 0 && startDate) {
                    dataPoints.push({
                        date: new Date(startDate).getTime(),
                        displayDate: startDate.substring(5).replace('-', '/'),
                        value: parseFloat(og),
                        type: 'start'
                    });
                }
                const regex = /- (\d{4}\/\d{2}\/\d{2}):\s*(-?\d+)\s*°Oe/g;
                let match;
                while ((match = regex.exec(log)) !== null) {
                    const dStr = match[1].replace(/\//g, '-');
                    const val = parseFloat(match[2]);
                    if (!isNaN(val)) {
                        dataPoints.push({
                            date: new Date(dStr).getTime(),
                            displayDate: match[1].substring(5),
                            value: val,
                            type: 'log'
                        });
                    }
                }
                return dataPoints.sort((a, b) => a.date - b.date);
            };

            // --- EFFECTS ---
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    if (u) {
                        setUser(u);
                        setIsOffline(false);
                    } else {
                        auth.signInAnonymously().catch(() => {
                            setIsOffline(true);
                            const localData = localStorage.getItem('mjod_batches');
                            if (localData) {
                                try { setSavedBatches(JSON.parse(localData).sort((a, b) => b.id - a.id)); } catch(e) {}
                            }
                        });
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || isOffline) return;
                const unsubscribe = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('batches')
                    .onSnapshot((snapshot) => {
                        const batches = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setSavedBatches(batches.sort((a, b) => (b.id > a.id ? 1 : -1)));
                    }, () => setIsOffline(true));
                return () => unsubscribe();
            }, [user, isOffline]);

            useEffect(() => {
                function handleClickOutside(event) {
                    if (batchMenuRef.current && !batchMenuRef.current.contains(event.target)) {
                        setShowBatchMenu(false);
                    }
                }
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [batchMenuRef]);

            // --- ACTIONS ---
            const handleGoogleLogin = async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try { await auth.signInWithPopup(provider); } catch (e) { alert("Inloggning misslyckades: " + e.code); }
            };

            const handleLogout = async () => {
                await auth.signOut();
                auth.signInAnonymously().catch(() => setIsOffline(true));
            };

            const handleAddLogEntry = () => {
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
                const newEntry = `- ${today}: ${fg} °Oe, ${calculateCurrentABV()}% ABV (${calculateAttenuation()}% utjäst)\n`;
                setLog(prev => prev + newEntry);
            };

            const handleAddDateOnly = () => {
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
                setLog(prev => {
                    const prefix = (prev.length > 0 && !prev.endsWith('\n')) ? '\n' : '';
                    return prev + prefix + `- ${today}: `;
                });
            };

            const handleSaveBatch = async () => {
                if (!batchName.trim()) return setNameError(true);
                if (isSaving) return;
                setIsSaving(true);
                setNameError(false);
                const data = { name: batchName, startDate, lastModified: new Date().toLocaleDateString('sv-SE'), ingredients, log, og, ogTemp, fg, fgTemp };
                try {
                    let finalId = currentBatchId || Date.now().toString();
                    if (!currentBatchId) setCurrentBatchId(finalId);
                    if (isOffline || !user) {
                        const existing = savedBatches.find(b => b.id === finalId);
                        let newBatches = existing ? savedBatches.map(b => b.id === finalId ? { ...data, id: finalId } : b) : [...savedBatches, { ...data, id: finalId }];
                        const sorted = newBatches.sort((a, b) => (b.id > a.id ? 1 : -1));
                        setSavedBatches(sorted);
                        localStorage.setItem('mjod_batches', JSON.stringify(sorted));
                    } else {
                        await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('batches').doc(finalId).set(data, { merge: true });
                    }
                } catch (e) { alert("Fel vid sparning."); } finally { setIsSaving(false); }
            };

            const handleLoadBatch = (b) => {
                setCurrentBatchId(b.id); setBatchName(b.name); setStartDate(b.startDate || new Date().toISOString().split('T')[0]);
                setIngredients(b.ingredients || ''); setLog(b.log || ''); setOg(b.og || 0); setOgTemp(b.ogTemp || 20);
                setFg(b.fg || 0); setFgTemp(b.fgTemp || 20); setNameError(false); setShowBatchMenu(false);
            };

            const handleNewBatchClick = () => setShowNewBatchConfirm(true);

            const proceedToNewBatch = () => {
                setCurrentBatchId(null); setBatchName(''); setStartDate(new Date().toISOString().split('T')[0]);
                setIngredients(''); setLog(''); setOg(0); setOgTemp(20); setFg(0); setFgTemp(20);
                setNameError(false); setShowNewBatchConfirm(false); setShowBatchMenu(false);
            };

            const confirmDeleteBatch = async () => {
                if (batchToDelete) {
                    if (isOffline) {
                        const newBatches = savedBatches.filter(b => b.id !== batchToDelete);
                        setSavedBatches(newBatches); localStorage.setItem('mjod_batches', JSON.stringify(newBatches));
                    } else if (user) {
                        await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('batches').doc(batchToDelete).delete();
                    }
                    if (currentBatchId === batchToDelete) proceedToNewBatch();
                    setShowDeleteModal(false); setBatchToDelete(null);
                }
            };

            const handleExportData = () => {
                if(savedBatches.length === 0) return alert("Inget att exportera");
                const blob = new Blob([JSON.stringify(savedBatches, null, 2)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `mjod-backup.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if(Array.isArray(data)) {
                            const currentIds = new Set(savedBatches.map(b => b.id));
                            let count = 0;
                            for(const b of data) {
                                if(!currentIds.has(b.id)) {
                                    const newId = b.id || (Date.now() + Math.floor(Math.random()*1000)).toString();
                                    const {id, ...rest} = b;
                                    if (isOffline) { savedBatches.push({...rest, id: newId}); }
                                    else { await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('batches').doc(newId).set(rest); }
                                    count++;
                                }
                            }
                            if (isOffline) {
                                const sorted = savedBatches.sort((a,b) => (b.id > a.id ? 1 : -1));
                                setSavedBatches(sorted); localStorage.setItem('mjod_batches', JSON.stringify(sorted));
                            }
                            alert(`Importerade ${count} st.`);
                        }
                    } catch(err) { alert("Fel vid import"); }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const handleFillTestData = async () => {
                const start1 = new Date(); start1.setDate(start1.getDate()-45);
                const start2 = new Date(); start2.setDate(start2.getDate()-20);

                const batch1 = {
                    name: "Viking Blod (Test)",
                    startDate: start1.toISOString().split('T')[0],
                    lastModified: new Date().toLocaleDateString('sv-SE'),
                    ingredients: "4 kg Honung\n12 l Vatten\n60g Hibiskus\nLalvin D-47",
                    log: `- ${start1.toISOString().split('T')[0].replace(/-/g,'/')}: 110 °Oe\n- ${new Date(start1.getTime()+86400000*14).toISOString().split('T')[0].replace(/-/g,'/')}: 45 °Oe\n- ${new Date(start1.getTime()+86400000*30).toISOString().split('T')[0].replace(/-/g,'/')}: 5 °Oe\n`,
                    og: 110, ogTemp: 20, fg: 5, fgTemp: 20
                };

                const batch2 = {
                    name: "Sommaräng (Test)",
                    startDate: start2.toISOString().split('T')[0],
                    lastModified: new Date().toLocaleDateString('sv-SE'),
                    ingredients: "3 kg Honung\n10 l Vatten\nFläderblommor\nCitron",
                    log: `- ${start2.toISOString().split('T')[0].replace(/-/g,'/')}: 95 °Oe\n- ${new Date(start2.getTime()+86400000*10).toISOString().split('T')[0].replace(/-/g,'/')}: 30 °Oe\n`,
                    og: 95, ogTemp: 20, fg: 12, fgTemp: 20
                };

                const examples = [batch1, batch2];
                for (let i = 0; i < examples.length; i++) {
                    const id = (Date.now() + i).toString();
                    if (isOffline || !user) {
                        setSavedBatches(prev => {
                            const newList = [...prev, { ...examples[i], id }].sort((a,b) => (b.id > a.id ? 1 : -1));
                            localStorage.setItem('mjod_batches', JSON.stringify(newList));
                            return newList;
                        });
                    } else {
                        await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('batches').doc(id).set(examples[i]);
                    }
                }
                alert("Två testbatcher har lagts till!");
                handleLoadBatch({...batch1, id: Date.now().toString()});
            };

            const handleCreateReminder = (days) => {
                const d = new Date(); d.setDate(d.getDate() + days); d.setHours(18,0,0,0);
                const iso = d.toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z';
                const content = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nDTSTART:${iso}\nSUMMARY:Mjödbryggning: ${batchName || 'Batch'}\nDESCRIPTION:Dags att titta till mjödet.\nEND:VEVENT\nEND:VCALENDAR`;
                const url = URL.createObjectURL(new Blob([content], {type: 'text/calendar'}));
                const a = document.createElement('a'); a.href = url; a.download = `mjod-event.ics`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                setShowReminderMenu(false);
            };

            // Beräkningar
            const potentialABV = calculatePotentialABV();
            const currentABV = calculateCurrentABV();
            const attenuation = calculateAttenuation();
            const sweetness = getSweetnessStatus();
            const graphData = getGraphData();
            const oechsleOptions = Array.from({ length: 136 }, (_, i) => i - 15);

            return (
                <div className="flex flex-col min-h-screen bg-slate-900 text-orange-100 selection:bg-orange-500/30">
                    
                    {/* MODALER */}
                    {showInfo && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-950/70 backdrop-blur-sm" onClick={() => setShowInfo(false)}>
                            <div className="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto custom-scrollbar p-6" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                                    <h2 className="text-xl font-bold text-orange-400 flex gap-2"><Icon name="Info"/> Guide</h2>
                                    <button onClick={() => setShowInfo(false)} className="text-slate-400 hover:text-white transition-colors"><Icon name="X"/></button>
                                </div>
                                <div className="space-y-6 text-sm text-slate-300 leading-relaxed">
                                    <section>
                                        <h3 className="font-bold text-orange-200 border-b border-slate-700 pb-1 mb-2 uppercase tracking-wider text-xs">Instruktioner</h3>
                                        <ul className="list-disc pl-5 space-y-2">
                                            <li>Spara batcher i molnet genom inloggning (Google).</li>
                                            <li>Jäskurvan ritas automatiskt om loggen innehåller datum och värde (t.ex. 2024/01/01: 10 °Oe).</li>
                                            <li>Öchsle korrigeras automatiskt mot 20°C.</li>
                                        </ul>
                                    </section>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showDeleteModal && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-950/70 backdrop-blur-sm" onClick={() => setShowDeleteModal(false)}>
                            <div className="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl p-6 max-w-sm w-full" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold text-orange-400 mb-2 flex gap-2"><Icon name="Trash2"/> Ta bort?</h3>
                                <div className="flex justify-end gap-2 mt-4">
                                    <button onClick={() => setShowDeleteModal(false)} className="px-3 py-1.5 rounded hover:bg-slate-700">Avbryt</button>
                                    <button onClick={confirmDeleteBatch} className="px-3 py-1.5 rounded bg-red-900 text-white">Ta bort</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showNewBatchConfirm && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-950/70 backdrop-blur-sm" onClick={() => setShowNewBatchConfirm(false)}>
                            <div className="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl p-6 max-w-sm w-full" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold text-orange-400 mb-2 flex gap-2"><Icon name="AlertTriangle"/> Skapa ny batch?</h3>
                                <div className="flex flex-col gap-2">
                                    <button onClick={() => { handleSaveBatch(); setShowNewBatchConfirm(false); }} className="w-full bg-orange-500 text-slate-950 font-bold py-2 rounded">Spara nuvarande först</button>
                                    <button onClick={proceedToNewBatch} className="w-full py-2 rounded hover:bg-slate-700 text-slate-400 text-xs">Fortsätt utan att spara</button>
                                    <button onClick={() => setShowNewBatchConfirm(false)} className="w-full py-2 rounded bg-slate-700 text-white text-xs">Avbryt</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* HEADER */}
                    <header className="flex-none border-b border-slate-800 sticky top-0 bg-slate-900/95 backdrop-blur z-40">
                        <div className="max-w-2xl mx-auto w-full p-4 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <h1 className="text-xl font-bold tracking-tight text-orange-400">Mjöd</h1>
                                <span onClick={handleFillTestData} className="text-[10px] font-mono border border-orange-500/20 px-1.5 py-0.5 rounded cursor-pointer hover:text-orange-200" title="Skapa två test-batcher">v1.1.9</span>
                                <button onClick={() => setShowInfo(true)} className="text-slate-500 hover:text-orange-400"><Icon name="Info" size={18}/></button>
                            </div>
                            
                            <div className="flex items-center gap-2">
                                <div className="relative" ref={batchMenuRef}>
                                    <button onClick={() => setShowBatchMenu(!showBatchMenu)} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border border-transparent transition-all ${showBatchMenu ? 'bg-orange-500/10 text-orange-400 border-orange-500/30' : 'text-slate-400 hover:bg-slate-800'}`}>
                                        <Icon name="FolderOpen" size={16}/> <span className="text-xs font-medium hidden sm:inline">Mina Batcher</span> <Icon name="ChevronDown" size={14}/>
                                    </button>
                                    {showBatchMenu && (
                                        <div className="fixed left-1/2 -translate-x-1/2 top-16 sm:absolute sm:left-auto sm:right-0 sm:translate-x-0 sm:top-full mt-2 w-[calc(100vw-2rem)] max-w-sm sm:w-80 bg-slate-900 border border-slate-700 rounded-xl shadow-2xl z-50 flex flex-col overflow-hidden origin-top animate-in fade-in zoom-in-95 duration-200">
                                            <div className="p-3 bg-slate-950/50 border-b border-slate-800 flex justify-between items-center text-xs text-slate-400">
                                                <span className="flex gap-2 items-center"><Icon name="User" size={14}/> {isOffline ? 'Offline' : (user && !user.isAnonymous ? 'Inloggad' : 'Gäst')}</span>
                                                {!isOffline && (user && !user.isAnonymous ? <button onClick={handleLogout} className="text-orange-400">Ut</button> : <button onClick={handleGoogleLogin} className="text-orange-400 font-bold underline">Logga in</button>)}
                                            </div>
                                            <div className="p-2 border-b border-slate-800">
                                                <button onClick={handleNewBatchClick} className="w-full py-2 border-2 border-dashed border-slate-700 rounded text-slate-400 hover:text-orange-300 text-xs font-bold uppercase flex justify-center gap-2"><Icon name="Plus" size={14}/> Ny Batch</button>
                                            </div>
                                            <div className="max-h-80 overflow-y-auto custom-scrollbar p-2 space-y-1">
                                                {savedBatches.length === 0 ? <p className="text-center text-xs text-slate-600 py-4 italic">Inga sparade brygder</p> : 
                                                savedBatches.map(b => (
                                                    <div key={b.id} onClick={() => handleLoadBatch(b)} className={`p-2 rounded border cursor-pointer relative ${currentBatchId === b.id ? 'bg-orange-500/10 border-orange-500/40' : 'bg-slate-800/50 border-slate-800 hover:bg-slate-800'}`}>
                                                        <div className="flex justify-between items-start mb-1">
                                                            <span className={`text-sm font-medium truncate pr-6 ${currentBatchId === b.id ? 'text-orange-300' : 'text-slate-300'}`}>{b.name}</span>
                                                            <button onClick={(e) => {e.stopPropagation(); setBatchToDelete(b.id); setShowDeleteModal(true);}} className="text-slate-600 hover:text-red-400 absolute top-2 right-2"><Icon name="Trash2" size={14}/></button>
                                                        </div>
                                                        <div className="flex justify-between text-[10px] text-slate-500 font-mono">
                                                            <span>OG: {b.og}</span>
                                                            <span>{b.startDate} ({getDaysSince(b.startDate)}d)</span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="p-2 border-t border-slate-800 bg-slate-950/50 flex justify-between">
                                                <button onClick={() => fileInputRef.current.click()} className="text-[10px] text-slate-500 hover:text-orange-300 flex gap-1 items-center"><Icon name="Upload" size={12}/> Importera</button>
                                                <button onClick={handleExportData} className="text-[10px] text-slate-500 hover:text-orange-300 flex gap-1 items-center"><Icon name="Download" size={12}/> Exportera</button>
                                                <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".json" className="hidden"/>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className="h-5 w-px bg-slate-800 mx-1"></div>
                                <button onClick={handleSaveBatch} disabled={isSaving} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border border-orange-500/20 active:scale-95 transition-all ${isSaving ? 'opacity-50 bg-orange-500/10 text-orange-400' : 'text-orange-400 hover:bg-orange-500/10'}`}>
                                    <Icon name="Save" size={16} className={isSaving ? "saving-pulse" : ""}/> 
                                    <span className="text-xs font-medium hidden sm:inline">{isSaving ? 'Sparar...' : 'Spara'}</span>
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* MAIN CONTENT */}
                    <main className="flex-1 p-4 overflow-y-auto custom-scrollbar">
                        <div className="max-w-2xl mx-auto space-y-4 pb-10">
                            <section className="bg-slate-800 rounded-xl p-4 border border-slate-700 shadow-xl relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-500/0 via-orange-500/50 to-orange-500/0"></div>
                                <div className="space-y-4">
                                    <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                        <div className="flex justify-between items-center mb-1">
                                            <label className="text-[10px] font-bold text-orange-400/70 uppercase">Batchens Namn</label>
                                            {currentBatchId && <span className="text-[9px] font-mono text-slate-500 bg-slate-950 px-1.5 py-0.5 rounded border border-slate-800">ID: {currentBatchId}</span>}
                                        </div>
                                        <input type="text" value={batchName} onChange={e => setBatchName(e.target.value)} placeholder="Namn..." className={`w-full bg-slate-950/50 border rounded-md px-3 py-2 text-sm text-orange-100 focus:outline-none focus:ring-1 ${nameError ? 'border-red-500/50 focus:border-red-500' : 'border-slate-700 focus:border-orange-500/50'}`}/>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                            <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Startdatum</label>
                                            <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="w-full bg-transparent border-none text-sm text-orange-100 focus:outline-none" style={{colorScheme:'dark'}}/>
                                        </div>
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                            <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Status</label>
                                            <div className="text-xs font-medium text-orange-300 italic">{sweetness}</div>
                                        </div>
                                    </div>
                                    <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                        <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Ingredienser</label>
                                        <textarea rows="8" value={ingredients} onChange={e => setIngredients(e.target.value)} placeholder="Honung, vatten..." className="w-full bg-transparent border-none text-sm text-orange-100 focus:outline-none resize-none custom-scrollbar"/>
                                    </div>

                                    {/* OG */}
                                    <div className="flex items-center gap-2 mb-1">
                                        <div className="h-px flex-1 bg-slate-700/50"></div>
                                        <span className="text-[10px] font-bold text-orange-400/50 uppercase tracking-wider">Original Gravity</span>
                                        <div className="h-px flex-1 bg-slate-700/50"></div>
                                    </div>
                                    <div className="grid grid-cols-3 gap-3">
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                            <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">OG (°Oe)</label>
                                            <div className="relative">
                                                <select value={og} onChange={e => setOg(e.target.value)} className="w-full bg-transparent border-none text-sm text-orange-100 focus:outline-none cursor-pointer">
                                                    {oechsleOptions.map(v => <option key={v} value={v} className="bg-slate-900">{v}</option>)}
                                                </select>
                                                <div className="absolute inset-y-0 right-0 flex items-center pointer-events-none text-orange-400/50"><Icon name="ChevronDown" size={14}/></div>
                                            </div>
                                        </div>
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                            <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Temp</label>
                                            <input type="number" value={ogTemp} onChange={e => setOgTemp(e.target.value)} className="w-full bg-transparent border-none text-sm text-orange-100 focus:outline-none"/>
                                        </div>
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                            <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Potentiell ABV</label>
                                            <div className="text-lg font-bold text-orange-400">{potentialABV}%</div>
                                        </div>
                                    </div>

                                    {/* FG */}
                                    <div className="flex items-center gap-2 mb-1">
                                        <div className="h-px flex-1 bg-slate-700/50"></div>
                                        <span className="text-[10px] font-bold text-orange-400/50 uppercase tracking-wider">Aktuell / Final Gravity</span>
                                        <div className="h-px flex-1 bg-slate-700/50"></div>
                                    </div>
                                    <div className="grid grid-cols-3 gap-3">
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                            <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">FG (°Oe)</label>
                                            <div className="relative">
                                                <select value={fg} onChange={e => setFg(e.target.value)} className="w-full bg-transparent border-none text-sm text-orange-100 focus:outline-none cursor-pointer">
                                                    {oechsleOptions.map(v => <option key={v} value={v} className="bg-slate-900">{v}</option>)}
                                                </select>
                                                <div className="absolute inset-y-0 right-0 flex items-center pointer-events-none text-orange-400/50"><Icon name="ChevronDown" size={14}/></div>
                                            </div>
                                        </div>
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                            <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Temp</label>
                                            <input type="number" value={fgTemp} onChange={e => setFgTemp(e.target.value)} className="w-full bg-transparent border-none text-sm text-orange-100 focus:outline-none"/>
                                        </div>
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 relative overflow-hidden">
                                            <button onClick={handleAddLogEntry} className="absolute top-1 right-1 text-orange-500/50 hover:text-orange-400" title="Spara till logg"><Icon name="Save" size={14}/></button>
                                            <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Aktuell ABV</label>
                                            <div className="text-lg font-bold text-orange-400">{currentABV}%</div>
                                        </div>
                                    </div>

                                    {/* UTJÄSNING BAR */}
                                    <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                        <div className="flex justify-between text-[10px] mb-1.5 uppercase font-bold text-orange-400/70"><span>Utjäsning</span><span>{attenuation}%</span></div>
                                        <div className="h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                            <div className="h-full bg-orange-500 transition-all" style={{ width: `${Math.min(attenuation, 100)}%` }}></div>
                                        </div>
                                    </div>

                                    {/* LOGG */}
                                    <div className="flex items-center gap-2 mb-2">
                                        <div className="h-px flex-1 bg-slate-700/50"></div>
                                        <div className="flex items-center gap-3">
                                            <button onClick={handleAddDateOnly} className="flex items-center gap-1 text-orange-400/50 hover:text-orange-400" title="Ny loggrad">
                                                <Icon name="Plus" size={14}/>
                                                <span className="text-[10px] font-bold uppercase tracking-wider">Logg</span>
                                            </button>
                                            <div className="relative">
                                                <button onClick={() => setShowReminderMenu(!showReminderMenu)} className={`hover:text-orange-400 ${showReminderMenu ? 'text-orange-400' : 'text-orange-400/50'}`} title="Påminnelse">
                                                    <Icon name="Bell" size={14}/>
                                                </button>
                                                {showReminderMenu && (
                                                    <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-800 border border-slate-700 rounded-lg shadow-xl p-2 w-48 z-20">
                                                        <div className="px-1 mb-1 border-b border-slate-700 pb-1">
                                                            <select value={reminderType} onChange={e => setReminderType(e.target.value)} className="w-full bg-slate-900 text-xs text-slate-300 p-1 focus:outline-none">
                                                                <option value="measure">Mät Gravity</option>
                                                                <option value="feed">Tillsätt näring</option>
                                                                <option value="rack">Tappa om</option>
                                                            </select>
                                                        </div>
                                                        {[3, 7, 14, 30].map(d => (
                                                            <button key={d} onClick={() => handleCreateReminder(d)} className="w-full text-left text-[10px] px-2 py-1.5 hover:bg-slate-700 rounded text-slate-300">Om {d} dagar</button>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        <div className="h-px flex-1 bg-slate-700/50"></div>
                                    </div>
                                    <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                        <textarea rows="6" value={log} onChange={e => setLog(e.target.value)} placeholder="Skriv logg här..." className="w-full bg-transparent border-none text-sm text-orange-100 focus:outline-none resize-none custom-scrollbar font-mono mb-2"/>
                                    </div>

                                    {/* JÄSKURVA - ALLTID SYNLIG MED AXELVÄRDEN */}
                                    <div className="flex items-center gap-2 mb-2 mt-12">
                                        <div className="h-px flex-1 bg-slate-700/50"></div>
                                        <span className="text-[10px] font-bold text-orange-400/50 uppercase tracking-wider">Jäskurva</span>
                                        <div className="h-px flex-1 bg-slate-700/50"></div>
                                    </div>
                                    <div className="bg-slate-900/50 p-6 rounded-lg border border-slate-700/50">
                                        {graphData.length > 1 ? (
                                            <div className="h-48 w-full flex">
                                                {/* Y-axel labels */}
                                                <div className="w-8 flex flex-col justify-between items-end pr-2 text-[8px] text-slate-500 font-mono py-1">
                                                    <span>{Math.max(...graphData.map(d => d.value)) + 5}</span>
                                                    <span>{Math.round((Math.max(...graphData.map(d => d.value)) + Math.min(...graphData.map(d => d.value))) / 2)}</span>
                                                    <span>{Math.min(...graphData.map(d => d.value)) - 5}</span>
                                                </div>
                                                
                                                <div className="flex-1 flex flex-col">
                                                    {/* Graf-yta */}
                                                    <div className="flex-1 relative border-l border-b border-slate-800">
                                                        <svg className="absolute inset-0 w-full h-full overflow-visible" viewBox="0 0 100 100" preserveAspectRatio="none">
                                                            {/* Bakgrunds-grid */}
                                                            {[0, 25, 50, 75, 100].map(y => (
                                                                <line key={y} x1="0" y1={y} x2="100" y2={y} stroke="rgba(148, 163, 184, 0.05)" strokeWidth="1" vectorEffect="non-scaling-stroke"/>
                                                            ))}
                                                            
                                                            {/* Kurvan */}
                                                            <path d={`M ${graphData.map((pt, i) => {
                                                                const x = (i / (graphData.length - 1)) * 100;
                                                                const maxVal = Math.max(...graphData.map(d => d.value)) + 5;
                                                                const minVal = Math.min(...graphData.map(d => d.value)) - 5;
                                                                const range = maxVal - minVal;
                                                                const y = 100 - ((pt.value - minVal) / range * 100);
                                                                return `${x} ${y}`;
                                                            }).join(' L ')}`} fill="none" stroke="rgba(251, 146, 60, 0.6)" strokeWidth="2" strokeDasharray="4 4" vectorEffect="non-scaling-stroke"/>
                                                        </svg>
                                                        
                                                        {/* Datapunkter */}
                                                        {graphData.map((pt, i) => {
                                                            const x = (i / (graphData.length - 1)) * 100;
                                                            const maxVal = Math.max(...graphData.map(d => d.value)) + 5;
                                                            const minVal = Math.min(...graphData.map(d => d.value)) - 5;
                                                            const range = maxVal - minVal;
                                                            const y = 100 - ((pt.value - minVal) / range * 100);
                                                            return (
                                                                <div 
                                                                    key={i} 
                                                                    className={`absolute w-2 h-2 rounded-full -ml-1 -mt-1 border-2 border-orange-400 group cursor-help ${pt.type==='start'?'bg-slate-900':'bg-orange-400'}`} 
                                                                    style={{left: `${x}%`, top: `${y}%`}}
                                                                >
                                                                    <div className="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-800 text-orange-200 text-[8px] px-1 py-0.5 rounded border border-slate-700 whitespace-nowrap z-50">
                                                                        {pt.value} °Oe
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                    
                                                    {/* X-axel labels (Datum) */}
                                                    <div className="h-6 relative mt-1">
                                                        {graphData.map((pt, i) => {
                                                            // Visa bara etikett för första, sista och mitt-datapunkten om det är många
                                                            if (i === 0 || i === graphData.length - 1 || graphData.length < 5 || i % Math.floor(graphData.length/2) === 0) {
                                                                return (
                                                                    <div key={i} className="absolute text-[7px] text-slate-500 font-mono transform -translate-x-1/2" style={{left: `${(i / (graphData.length - 1)) * 100}%`}}>
                                                                        {pt.displayDate}
                                                                    </div>
                                                                );
                                                            }
                                                            return null;
                                                        })}
                                                    </div>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="h-32 w-full flex flex-col items-center justify-center text-[10px] text-slate-600 italic border border-dashed border-slate-800 rounded-lg">
                                                <Icon name="Activity" size={16} className="mb-2 opacity-30"/>
                                                Ingen jäshistorik tillgänglig.
                                                <span className="mt-1 opacity-50 text-[8px]">Skriv t.ex. "2024/01/01: 10 °Oe" i loggen för att se kurvan.</span>
                                            </div>
                                        )}
                                    </div>

                                </div>
                            </section>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
