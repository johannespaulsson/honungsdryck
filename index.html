<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mjödbryggning Pro</title>
    
    <!-- 1. Hämta designmotorn (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Hämta React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Hämta Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Hämta Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #0f172a; color: #ffedd5; font-family: ui-sans-serif, system-ui, sans-serif; margin: 0; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(251, 146, 60, 0.2); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(251, 146, 60, 0.4); }
        .saving-pulse { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- IKONER ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                Wrench: <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />,
                Archive: <><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></>,
                Plus: <path d="M5 12h14M12 5v14"/>,
                Save: <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2zM17 21v-8H7v8M7 3v5h8"/>,
                Activity: <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>,
                Trash2: <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"/>,
                Calendar: <><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>,
                Info: <><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></>,
                X: <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>,
                TrendingDown: <><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></>,
                Bell: <><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></>,
                ChevronDown: <path d="m6 9 6 6 6-6"/>,
                FolderOpen: <path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H18a2 2 0 0 1 2 2v2"/>,
                LogIn: <><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></>,
                LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>,
                User: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
                Download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>,
                Upload: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyDGmN-60JoFMFyKNtEVR4sRf258GTv2jU4",
            authDomain: "mjodbryggning.firebaseapp.com",
            projectId: "mjodbryggning",
            storageBucket: "mjodbryggning.firebasestorage.app",
            messagingSenderId: "795065616004",
            appId: "1:795065616004:web:27f329729112c0f09fa4d1",
            measurementId: "G-1GDMF1NNQ4"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "mjodbryggning-live"; 

        function App() {
            // --- STATES ---
            const [user, setUser] = useState(null);
            const [isOffline, setIsOffline] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [currentBatchId, setCurrentBatchId] = useState(null);
            const [showInfo, setShowInfo] = useState(false);
            const [showBatchMenu, setShowBatchMenu] = useState(false);
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [showNewBatchConfirm, setShowNewBatchConfirm] = useState(false); 
            const [batchToDelete, setBatchToDelete] = useState(null);
            const [showReminderMenu, setShowReminderMenu] = useState(false);
            const [reminderType, setReminderType] = useState('measure');
            const [nameError, setNameError] = useState(false);
            
            const [batchName, setBatchName] = useState('');
            const [startDate, setStartDate] = useState(new Date().toISOString().split('T')[0]);
            const [ingredients, setIngredients] = useState('');
            const [log, setLog] = useState('');
            const [og, setOg] = useState(0);
            const [ogTemp, setOgTemp] = useState(20);
            const [fg, setFg] = useState(0);
            const [fgTemp, setFgTemp] = useState(20);
            const [savedBatches, setSavedBatches] = useState([]);

            const fileInputRef = useRef(null);
            const batchMenuRef = useRef(null);

            // --- HJÄLPFUNKTIONER ---
            const getCorrectedGravity = (g, t) => {
                const grav = parseFloat(g);
                const temp = parseFloat(t);
                if (isNaN(grav) || isNaN(temp)) return 0;
                return grav + ((temp - 20) * 0.2);
            };

            const calculatePotentialABV = () => Math.max(0, getCorrectedGravity(og, ogTemp) / 7.5).toFixed(1);
            const calculateCurrentABV = () => {
                const cOG = getCorrectedGravity(og, ogTemp);
                const cFG = getCorrectedGravity(fg, fgTemp);
                if (cOG <= 0) return "0.0";
                return Math.max(0, (cOG - cFG) / 7.5).toFixed(1);
            };
            const calculateAttenuation = () => {
                const cOG = getCorrectedGravity(og, ogTemp);
                const cFG = getCorrectedGravity(fg, fgTemp);
                if (cOG <= 0) return "0.0";
                return Math.max(0, Math.min(100, ((cOG - cFG) / cOG) * 100)).toFixed(1);
            };
            const getSweetnessStatus = () => {
                const cFG = getCorrectedGravity(fg, fgTemp);
                if (og == 0 && fg == 0) return "-";
                if (cFG >= 45) return "Dessert / Mycket sött";
                if (cFG >= 25) return "Sött";
                if (cFG >= 12) return "Halvsött";
                if (cFG >= 4) return "Halvtorrt";
                return "Torrt";
            };
            const getDaysSince = (d) => {
                if (!d) return 0;
                const start = new Date(d); const today = new Date();
                start.setHours(0,0,0,0); today.setHours(0,0,0,0);
                return Math.max(0, Math.floor((today - start) / (1000 * 60 * 60 * 24)));
            };

            // UPPDATERAD: Hämtar nu enbart data från loggen och startvärdet (OG)
            const getGraphData = () => {
                const dataPoints = [];
                
                // 1. Lägg till OG som startpunkt (alltid vid startdatum)
                if (og > 0 && startDate) {
                    dataPoints.push({
                        date: new Date(startDate).getTime(),
                        displayDate: startDate.substring(5).replace('-', '/'),
                        value: parseFloat(og),
                        type: 'start'
                    });
                }
                
                // 2. Parsa loggen för historiska punkter
                // Letar efter format: "- ÅÅÅÅ/MM/DD: [värde] °Oe"
                const regex = /- (\d{4}\/\d{2}\/\d{2}):\s*(-?\d+)\s*°Oe/g;
                let match;
                while ((match = regex.exec(log)) !== null) {
                    const dStr = match[1].replace(/\//g, '-');
                    const val = parseFloat(match[2]);
                    if (!isNaN(val)) {
                        dataPoints.push({
                            date: new Date(dStr).getTime(),
                            displayDate: match[1].substring(5),
                            value: val,
                            type: 'log'
                        });
                    }
                }

                // 3. Sortera mätpunkter kronologiskt
                dataPoints.sort((a, b) => a.date - b.date);

                // NOTERA: Steg 4 (Live-punkten) är borttagen enligt användarens önskemål.
                // Grafen ritar nu bara vad som faktiskt finns loggat.

                return dataPoints;
            };

            const reminderOptions = {
                measure: { label: 'Mät Gravity', options: [{ label: '3 dagar', days: 3 }, { label: '1 vecka', days: 7 }, { label: '2 veckor', days: 14 }] },
                rack: { label: 'Tappa om', options: [{ label: '2 veckor', days: 14 }, { label: '4 veckor', days: 28 }, { label: '2 månader', days: 60 }] },
                feed: { label: 'Näring', options: [{ label: '24h (Dag 1)', days: 1 }, { label: '48h (Dag 2)', days: 2 }, { label: '72h (Dag 3)', days: 3 }, { label: '1 vecka', days: 7 }] },
                sweeten: { label: 'Eftersöta', options: [{ label: '3 dagar', days: 3 }, { label: '1 vecka', days: 7 }, { label: '2 veckor', days: 14 }] }
            };

            // --- EFFECTS ---
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    if (u) { setUser(u); setIsOffline(false); }
                    else {
                        auth.signInAnonymously().catch(() => {
                            setIsOffline(true);
                            const localData = localStorage.getItem('mjod_batches');
                            if (localData) setSavedBatches(JSON.parse(localData).sort((a, b) => b.id - a.id));
                        });
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || isOffline) return;
                const unsubscribe = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('batches')
                    .onSnapshot((snapshot) => {
                        const batches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setSavedBatches(batches.sort((a, b) => (b.id > a.id ? 1 : -1)));
                    }, () => setIsOffline(true));
                return () => unsubscribe();
            }, [user, isOffline]);

            useEffect(() => {
                function handleClickOutside(event) {
                    if (batchMenuRef.current && !batchMenuRef.current.contains(event.target)) {
                        setShowBatchMenu(false);
                    }
                }
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [batchMenuRef]);

            // --- ACTIONS ---
            const handleGoogleLogin = async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try { await auth.signInWithPopup(provider); } catch (e) { alert("Inloggning misslyckades: " + e.code); }
            };

            const handleLogout = async () => { await auth.signOut(); auth.signInAnonymously().catch(() => setIsOffline(true)); };

            const handleAddLogEntry = () => {
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
                setLog(prev => prev + (prev.length > 0 && !prev.endsWith('\n') ? '\n' : '') + `- ${today}: ${fg} °Oe, ${calculateCurrentABV()}% ABV (${calculateAttenuation()}% utjäst)\n`);
            };

            const handleAddDateOnly = () => {
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
                setLog(prev => prev + (prev.length > 0 && !prev.endsWith('\n') ? '\n' : '') + `- ${today}: `);
            };

            const handleSaveBatch = async () => {
                if (!batchName.trim()) return setNameError(true);
                if (isSaving) return;
                setIsSaving(true);
                const data = { name: batchName, startDate, lastModified: new Date().toLocaleDateString('sv-SE'), ingredients, log, og, ogTemp, fg, fgTemp };
                try {
                    let finalId = currentBatchId || Date.now().toString();
                    if (!currentBatchId) setCurrentBatchId(finalId);
                    if (isOffline || !user) {
                        const existing = savedBatches.find(b => b.id === finalId);
                        let newBatches = existing ? savedBatches.map(b => b.id === finalId ? { ...data, id: finalId } : b) : [...savedBatches, { ...data, id: finalId }];
                        setSavedBatches(newBatches.sort((a, b) => (b.id > a.id ? 1 : -1)));
                        localStorage.setItem('mjod_batches', JSON.stringify(newBatches));
                    } else {
                        await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('batches').doc(finalId).set(data, { merge: true });
                    }
                } catch (e) { alert("Fel vid sparning."); } finally { setIsSaving(false); }
            };

            const handleLoadBatch = (b) => {
                setCurrentBatchId(b.id); setBatchName(b.name); setStartDate(b.startDate || new Date().toISOString().split('T')[0]);
                setIngredients(b.ingredients || ''); setLog(b.log || ''); setOg(b.og || 0); setOgTemp(b.ogTemp || 20);
                setFg(b.fg || 0); setFgTemp(b.fgTemp || 20); setNameError(false); setShowBatchMenu(false);
            };

            const handleExportData = () => {
                if(savedBatches.length === 0) return alert("Inget att exportera");
                const blob = new Blob([JSON.stringify(savedBatches, null, 2)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `mjod-backup.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if(Array.isArray(data)) {
                            const currentIds = new Set(savedBatches.map(b => b.id));
                            for(const b of data) {
                                if(!currentIds.has(b.id)) {
                                    const newId = b.id || (Date.now() + Math.floor(Math.random()*1000)).toString();
                                    const {id, ...rest} = b;
                                    if (isOffline) { setSavedBatches(prev => [...prev, {...rest, id: newId}].sort((a,b) => (b.id > a.id ? 1 : -1))); }
                                    else { await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('batches').doc(newId).set(rest); }
                                }
                            }
                            alert("Import klar!");
                        }
                    } catch(err) { alert("Fel vid import"); }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const handleNewBatchClick = () => setShowNewBatchConfirm(true);
            const proceedToNewBatch = () => {
                setCurrentBatchId(null); setBatchName(''); setStartDate(new Date().toISOString().split('T')[0]);
                setIngredients(''); setLog(''); setOg(0); setOgTemp(20); setFg(0); setFgTemp(20);
                setNameError(false); setShowNewBatchConfirm(false); setShowBatchMenu(false);
            };

            const handleFillTestData = async () => {
                const s1 = new Date(); s1.setDate(s1.getDate()-60);
                const s2 = new Date(); s2.setDate(s2.getDate()-25);
                const getP = (start, days, val) => {
                    const d = new Date(start); d.setDate(d.getDate() + days);
                    const att = Math.max(0, Math.min(100, ((115 - val) / 115) * 100)).toFixed(1);
                    const abv = Math.max(0, (115 - val) / 7.5).toFixed(1);
                    return `- ${d.toISOString().split('T')[0].replace(/-/g,'/')}: ${val} °Oe, ${abv}% ABV (${att}% utjäst)\n`;
                };
                let log1 = ""; const pts1 = [{d:0,v:115}, {d:5,v:108}, {d:12,v:75}, {d:20,v:35}, {d:30,v:12}, {d:45,v:2}, {d:60,v:2}]; pts1.forEach(p => log1 += getP(s1, p.d, p.v));
                let log2 = ""; const pts2 = [{d:0,v:95}, {d:7,v:78}, {d:14,v:42}, {d:22,v:18}, {d:25,v:14}]; pts2.forEach(p => log2 += getP(s2, p.d, p.v));
                const b1 = { name: "Viking Blod (Test)", startDate: s1.toISOString().split('T')[0], ingredients: "4kg Ljung-honung\n12l Vatten\n60g Hibiskus", log: log1, og: 115, fg: 2 };
                const b2 = { name: "Sommaräng (Test)", startDate: s2.toISOString().split('T')[0], ingredients: "3kg Honung\nCitronzest", log: log2, og: 95, fg: 14 };
                const ex = [b1, b2];
                for (let i = 0; i < ex.length; i++) {
                    const id = (Date.now() + i).toString();
                    if (isOffline || !user) { setSavedBatches(prev => { const nl = [...prev, { ...ex[i], id }].sort((a,b) => (b.id > a.id ? 1 : -1)); localStorage.setItem('mjod_batches', JSON.stringify(nl)); return nl; }); }
                    else { await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('batches').doc(id).set(ex[i]); }
                }
                alert("Två testbatcher har lagts till!");
            };

            const handleCreateReminder = (days) => {
                const targetD = new Date(); targetD.setDate(targetD.getDate() + days);
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
                const targetDStr = targetD.toISOString().split('T')[0].replace(/-/g, '/');
                
                const label = reminderOptions[reminderType].label;
                setLog(prev => prev + (prev.length > 0 && !prev.endsWith('\n') ? '\n' : '') + `- ${today}: Planerad åtgärd den ${targetDStr} - ${label}\n`);

                const iso = targetD.toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z';
                const content = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nDTSTART:${iso}\nSUMMARY:Mjöd (${label}): ${batchName}\nEND:VEVENT\nEND:VCALENDAR`;
                const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([content], {type: 'text/calendar'}));
                a.download = `mjod-event.ics`; a.click(); setShowReminderMenu(false);
            };

            const confirmDeleteBatch = async () => {
                if (batchToDelete) {
                    if (isOffline) { const nl = savedBatches.filter(b => b.id !== batchToDelete); setSavedBatches(nl); localStorage.setItem('mjod_batches', JSON.stringify(nl)); }
                    else { await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('batches').doc(batchToDelete).delete(); }
                    if (currentBatchId === batchToDelete) proceedToNewBatch();
                    setShowDeleteModal(false); setBatchToDelete(null);
                }
            };

            const potentialABV = calculatePotentialABV();
            const currentABV = calculateCurrentABV();
            const attenuation = calculateAttenuation();
            const sweetness = getSweetnessStatus();
            const graphData = getGraphData();
            const oechsleOptions = Array.from({ length: 156 }, (_, i) => i - 15);
            const remOpts = reminderOptions[reminderType].options;

            return (
                <div className="flex flex-col min-h-screen bg-slate-900 text-orange-100 selection:bg-orange-500/30">
                    
                    {/* MODALER */}
                    {showInfo && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-950/70 backdrop-blur-sm" onClick={() => setShowInfo(false)}>
                            <div className="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto custom-scrollbar p-6" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                                    <h2 className="text-xl font-bold text-orange-400 flex gap-2"><Icon name="Info"/> Guide</h2>
                                    <button onClick={() => setShowInfo(false)} className="text-slate-400 hover:text-white transition-colors"><Icon name="X"/></button>
                                </div>
                                <div className="space-y-6 text-sm text-slate-300 leading-relaxed">
                                    <section>
                                        <h3 className="font-bold text-orange-200 uppercase text-xs border-b border-slate-700 mb-2 pb-1">Hur man använder appen</h3>
                                        <ul className="list-disc pl-5 space-y-2">
                                            <li><span className="text-orange-100 font-medium">Spara & Synka:</span> Dina batcher sparas automatiskt i molnet om du är inloggad. Klicka på "Spara" för att skicka upp senaste ändringarna.</li>
                                            <li><span className="text-orange-100 font-medium">Logg & Graf:</span> Skriv ner dina mätningar i loggen med formatet <code className="bg-slate-950 px-1 rounded text-orange-400">ÅÅÅÅ/MM/DD: 10 °Oe</code> så ritas grafen automatiskt.</li>
                                            <li><span className="text-orange-100 font-medium">Påminnelser:</span> Klicka på klock-ikonen vid loggen för att ladda ner en kalenderfil för viktiga händelser (Näring, Rackning, Eftersötning).</li>
                                        </ul>
                                    </section>

                                    <section>
                                        <h3 className="font-bold text-orange-200 uppercase text-xs border-b border-slate-700 mb-2 pb-1">Att mäta Öchsle (°Oe)</h3>
                                        <p className="mb-2">Öchslevikten talar om hur mycket socker som finns i vätskan. </p>
                                        <ul className="list-disc pl-5 space-y-2">
                                            <li><span className="text-orange-100 font-medium">OG (Original Gravity):</span> Värdet innan jäsning. Avgör hur starkt mjödet kan bli.</li>
                                            <li><span className="text-orange-100 font-medium">FG (Final Gravity):</span> Värdet när det slutat jäsa. Avgör hur sött det färdiga mjödet är.</li>
                                            <li><span className="text-orange-100 font-medium">Temperatur:</span> Mätaren är kalibrerad för 20°C. Om vätskan är varmare eller kallare korrigerar appen detta automatiskt (+/- 0.2 per grad).</li>
                                        </ul>
                                    </section>

                                    <section>
                                        <h3 className="font-bold text-orange-200 uppercase text-xs border-b border-slate-700 mb-2 pb-1">Sötma-skala (FG)</h3>
                                        <div className="grid grid-cols-2 gap-2 text-xs">
                                            <div className="bg-slate-900 p-2 rounded border border-slate-700"><strong>Torrt:</strong> Under 4 °Oe</div>
                                            <div className="bg-slate-900 p-2 rounded border border-slate-700"><strong>Halvtorrt:</strong> 4 - 12 °Oe</div>
                                            <div className="bg-slate-900 p-2 rounded border border-slate-700"><strong>Halvsött:</strong> 12 - 25 °Oe</div>
                                            <div className="bg-slate-900 p-2 rounded border border-slate-700"><strong>Sött:</strong> Över 25 °Oe</div>
                                        </div>
                                    </section>

                                    <section className="bg-orange-500/10 p-3 rounded-lg border border-orange-500/20">
                                        <h3 className="font-bold text-orange-400 mb-1">Tips för bättre mjöd</h3>
                                        <p className="italic text-xs">Se till att syresätta musten ordentligt innan du tillsätter jästen, men undvik syre helt efter att de första dagarna av jäsning har passerat för att undvika oxidering. Använd jästnäring i intervaller för att undvika svaveldoft (H2S).</p>
                                    </section>
                                </div>
                            </div>
                        </div>
                    )}

                    {showDeleteModal && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-950/70 backdrop-blur-sm" onClick={() => setShowDeleteModal(false)}>
                            <div className="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl p-6 max-w-sm w-full" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold text-orange-400 mb-2 flex gap-2"><Icon name="Trash2"/> Ta bort?</h3>
                                <div className="flex justify-end gap-2 mt-4">
                                    <button onClick={() => setShowDeleteModal(false)} className="px-3 py-1.5 rounded hover:bg-slate-700">Avbryt</button>
                                    <button onClick={confirmDeleteBatch} className="px-3 py-1.5 rounded bg-red-900 text-white">Ta bort</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showNewBatchConfirm && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-950/70 backdrop-blur-sm" onClick={() => setShowNewBatchConfirm(false)}>
                            <div className="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl p-6 max-w-sm w-full" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold text-orange-400 mb-2 flex gap-2"><Icon name="AlertTriangle"/> Ny batch?</h3>
                                <p className="text-slate-300 text-sm mb-4">Spara nuvarande först!</p>
                                <div className="flex flex-col gap-2">
                                    <button onClick={() => { handleSaveBatch(); setShowNewBatchConfirm(false); }} className="w-full bg-orange-500 text-slate-950 font-bold py-2 rounded hover:bg-orange-400">Spara först</button>
                                    <button onClick={proceedToNewBatch} className="w-full py-2 rounded hover:bg-slate-700 text-slate-400 text-xs">Fortsätt utan att spara</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* HEADER */}
                    <header className="flex-none border-b border-slate-800 sticky top-0 bg-slate-900/95 backdrop-blur z-40 shadow-md">
                        <div className="max-w-2xl mx-auto w-full p-4 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <h1 className="text-xl font-bold tracking-tight text-orange-400">Mjöd</h1>
                                <span onClick={handleFillTestData} className="text-[10px] font-mono border border-orange-500/20 px-1.5 py-0.5 rounded cursor-pointer hover:text-orange-200" title="Skapa test-batcher">v1.2.6</span>
                                <button onClick={() => setShowInfo(true)} className="text-slate-500 hover:text-orange-400"><Icon name="Info" size={18}/></button>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="relative" ref={batchMenuRef}>
                                    <button onClick={() => setShowBatchMenu(!showBatchMenu)} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border border-transparent transition-all ${showBatchMenu ? 'bg-orange-500/10 text-orange-400 border-orange-500/30' : 'text-slate-400 hover:bg-slate-800'}`}>
                                        <Icon name="FolderOpen" size={16}/> <span className="text-xs font-medium hidden sm:inline">Mina Batcher</span> <Icon name="ChevronDown" size={14}/>
                                    </button>
                                    {showBatchMenu && (
                                        <div className="fixed left-1/2 -translate-x-1/2 top-16 sm:absolute sm:left-auto sm:right-0 sm:translate-x-0 sm:top-full mt-2 w-[calc(100vw-2rem)] max-w-sm sm:w-80 bg-slate-900 border border-slate-700 rounded-xl shadow-2xl z-50 flex flex-col overflow-hidden animate-in fade-in zoom-in-95 duration-100 origin-top-right">
                                            <div className="p-3 bg-slate-950/50 border-b border-slate-800 flex justify-between items-center text-xs text-slate-400">
                                                <span><Icon name="User" size={14} className="inline mr-2"/> {isOffline ? 'Offline' : (user && !user.isAnonymous ? 'Inloggad' : 'Gäst')}</span>
                                                {!isOffline && (user && !user.isAnonymous ? <button onClick={handleLogout} className="text-orange-400">Ut</button> : <button onClick={handleGoogleLogin} className="text-orange-400 font-bold underline">Logga in</button>)}
                                            </div>
                                            <div className="p-2 border-b border-slate-800">
                                                <button onClick={handleNewBatchClick} className="w-full py-2 border-2 border-dashed border-slate-700 rounded text-slate-400 hover:text-orange-300 text-xs font-bold uppercase flex justify-center gap-2 transition-colors"><Icon name="Plus" size={14}/> Ny Batch</button>
                                            </div>
                                            <div className="max-h-80 overflow-y-auto custom-scrollbar p-2 space-y-1">
                                                {savedBatches.length === 0 ? <p className="text-center text-xs py-4 text-slate-600 italic">Inga sparade brygder</p> : 
                                                savedBatches.map(b => (
                                                    <div key={b.id} onClick={() => handleLoadBatch(b)} className={`p-2 rounded border cursor-pointer relative transition-all ${currentBatchId === b.id ? 'bg-orange-500/10 border-orange-500/40' : 'bg-slate-800/50 border-slate-800 hover:bg-slate-800'}`}>
                                                        <div className="flex justify-between items-start mb-1">
                                                            <span className={`text-sm font-medium truncate pr-6 ${currentBatchId === b.id ? 'text-orange-300' : 'text-slate-300'}`}>{b.name}</span>
                                                            <button onClick={(e) => {e.stopPropagation(); setBatchToDelete(b.id); setShowDeleteModal(true);}} className="text-slate-600 hover:text-red-400 absolute top-2 right-2"><Icon name="Trash2" size={14}/></button>
                                                        </div>
                                                        <div className="flex justify-between text-[10px] text-slate-500 font-mono"><span>OG: {b.og}</span><span>{b.startDate} ({getDaysSince(b.startDate)}d)</span></div>
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="p-2 border-t border-slate-800 bg-slate-950/50 flex justify-between">
                                                <button onClick={() => fileInputRef.current.click()} className="text-[10px] text-slate-500 hover:text-orange-300 flex items-center gap-1"><Icon name="Upload" size={12}/> Importera</button>
                                                <button onClick={handleExportData} className="text-[10px] text-slate-500 hover:text-orange-300 flex items-center gap-1"><Icon name="Download" size={12}/> Exportera</button>
                                                <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".json" className="hidden"/>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className="h-5 w-px bg-slate-800 mx-1"></div>
                                <button onClick={handleSaveBatch} disabled={isSaving} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border border-orange-500/20 active:scale-95 transition-all ${isSaving ? 'opacity-50 bg-orange-500/10 text-orange-400 cursor-not-allowed' : 'text-orange-400 hover:bg-orange-500/10'}`}>
                                    <Icon name="Save" size={16} className={isSaving ? "saving-pulse" : ""}/> <span className="text-xs font-medium hidden sm:inline">{isSaving ? 'Sparar...' : 'Spara'}</span>
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="flex-1 p-4 overflow-y-auto custom-scrollbar">
                        <div className="max-w-2xl mx-auto space-y-4 pb-10">
                            <section className="bg-slate-800 rounded-xl p-4 border border-slate-700 shadow-xl relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-500/0 via-orange-500/50 to-orange-500/0"></div>
                                <div className="space-y-4">
                                    <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                        <div className="flex justify-between items-center mb-1">
                                            <label className="text-[10px] font-bold text-orange-400/70 uppercase">Batchens Namn</label>
                                            {currentBatchId && <span className="text-[9px] font-mono text-slate-500 bg-slate-950 px-1.5 py-0.5 rounded border border-slate-800">ID: {currentBatchId}</span>}
                                        </div>
                                        <input type="text" value={batchName} onChange={e => setBatchName(e.target.value)} placeholder="Namn..." className={`w-full bg-slate-950/50 border rounded-md px-3 py-2 text-sm text-orange-100 focus:outline-none focus:ring-1 ${nameError ? 'border-red-500/50 focus:border-red-500' : 'border-slate-700 focus:border-orange-500/50'}`}/>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                            <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Startdatum</label>
                                            <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="w-full bg-transparent border-none text-sm text-orange-100 focus:outline-none" style={{colorScheme:'dark'}}/>
                                        </div>
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                            <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Sötma/Status</label>
                                            <div className="text-xs font-medium text-orange-300 italic">{sweetness}</div>
                                        </div>
                                    </div>
                                    <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                        <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Ingredienser</label>
                                        <textarea rows="8" value={ingredients} onChange={e => setIngredients(e.target.value)} placeholder="Honung, vatten..." className="w-full bg-transparent border-none text-sm text-orange-100 focus:outline-none resize-none custom-scrollbar font-medium"/>
                                    </div>

                                    <div className="flex items-center gap-2 mb-1"><div className="h-px flex-1 bg-slate-700/50"></div><span className="text-[10px] font-bold text-orange-400/50 uppercase tracking-wider">Original Gravity</span><div className="h-px flex-1 bg-slate-700/50"></div></div>
                                    <div className="grid grid-cols-3 gap-3">
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50"><label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">OG (°Oe)</label>
                                            <select value={og} onChange={e => setOg(e.target.value)} className="w-full bg-transparent border-none text-sm text-orange-100 focus:outline-none cursor-pointer">
                                                {oechsleOptions.map(v => <option key={v} value={v} className="bg-slate-900">{v}</option>)}
                                            </select>
                                        </div>
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50"><label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Temp</label><input type="number" value={ogTemp} onChange={e => setOgTemp(e.target.value)} className="w-full bg-transparent border-none text-sm text-orange-100 focus:outline-none"/></div>
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 relative"><label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Potentiell ABV</label><div className="text-lg font-bold text-orange-400">{potentialABV}%</div></div>
                                    </div>

                                    <div className="flex items-center gap-2 mb-1"><div className="h-px flex-1 bg-slate-700/50"></div><span className="text-[10px] font-bold text-orange-400/50 uppercase tracking-wider">Aktuell / Final Gravity</span><div className="h-px flex-1 bg-slate-700/50"></div></div>
                                    <div className="grid grid-cols-3 gap-3">
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50"><label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">FG (°Oe)</label>
                                            <select value={fg} onChange={e => setFg(e.target.value)} className="w-full bg-transparent border-none text-sm text-orange-100 focus:outline-none cursor-pointer">
                                                {oechsleOptions.map(v => <option key={v} value={v} className="bg-slate-900">{v}</option>)}
                                            </select>
                                        </div>
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50"><label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Temp</label><input type="number" value={fgTemp} onChange={e => setFgTemp(e.target.value)} className="w-full bg-transparent border-none text-sm text-orange-100 focus:outline-none"/></div>
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 relative overflow-hidden group">
                                            <button onClick={handleAddLogEntry} className="absolute top-1 right-1 text-orange-500/50 hover:text-orange-400 transition-colors" title="Spara mätvärde till logg (visas då i grafen)"><Icon name="Save" size={14}/></button>
                                            <label className="text-[10px] font-bold text-orange-400/70 uppercase mb-1 block">Aktuell ABV</label>
                                            <div className="text-lg font-bold text-orange-400">{currentABV}%</div>
                                        </div>
                                    </div>

                                    <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                        <div className="flex justify-between text-[10px] mb-1.5 uppercase font-bold text-orange-400/70"><span>Utjäsning</span><span>{attenuation}%</span></div>
                                        <div className="h-1.5 bg-slate-700 rounded-full overflow-hidden"><div className="h-full bg-orange-500 transition-all duration-700 ease-out" style={{ width: `${Math.min(attenuation, 100)}%` }}></div></div>
                                    </div>

                                    <div className="flex items-center gap-2 mb-2 pt-4">
                                        <div className="h-px flex-1 bg-slate-700/50"></div>
                                        <div className="flex items-center gap-3">
                                            <button onClick={handleAddDateOnly} className="flex items-center gap-1 text-orange-400/50 hover:text-orange-400 transition-colors p-1 hover:bg-slate-900 rounded"><Icon name="Plus" size={14}/><span className="text-[10px] font-bold uppercase">Logg</span></button>
                                            <div className="relative">
                                                <button onClick={() => setShowReminderMenu(!showReminderMenu)} className={`hover:text-orange-400 transition-colors p-1 hover:bg-slate-900 rounded ${showReminderMenu ? 'text-orange-400 bg-slate-900' : 'text-orange-400/50'}`}><Icon name="Bell" size={14}/></button>
                                                {showReminderMenu && (
                                                    <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-800 border border-slate-700 rounded-lg shadow-xl p-2 w-48 z-20 animate-in fade-in zoom-in-95 duration-100">
                                                        <div className="flex justify-between items-center mb-1 border-b border-slate-700 pb-1">
                                                            <label className="text-[9px] text-slate-400 uppercase pl-1">Typ</label>
                                                            <button onClick={() => setShowReminderMenu(false)} className="text-slate-500 hover:text-orange-400 transition-colors"><Icon name="X" size={10} /></button>
                                                        </div>
                                                        <div className="px-1 mb-1">
                                                            <select value={reminderType} onChange={e => setReminderType(e.target.value)} className="w-full bg-slate-900 text-xs text-slate-300 p-1 focus:outline-none rounded border border-slate-700">
                                                                <option value="measure">Mät Gravity</option>
                                                                <option value="feed">Näring</option>
                                                                <option value="rack">Tappa om</option>
                                                                <option value="sweeten">Eftersöta</option>
                                                            </select>
                                                        </div>
                                                        <div className="max-h-40 overflow-y-auto custom-scrollbar">
                                                            {remOpts.map(opt => <button key={opt.label} onClick={() => handleCreateReminder(opt.days)} className="w-full text-left text-[10px] px-2 py-2 hover:bg-slate-700 rounded text-slate-300 transition-colors">{opt.label}</button>)}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        <div className="h-px flex-1 bg-slate-700/50"></div>
                                    </div>
                                    <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                        <textarea rows="6" value={log} onChange={e => setLog(e.target.value)} placeholder="Anteckningar..." className="w-full bg-transparent border-none text-sm text-orange-100 font-mono mb-2 custom-scrollbar focus:outline-none"/>
                                    </div>

                                    {/* JÄSKURVA */}
                                    <div className="flex items-center gap-2 mb-2 mt-12"><div className="h-px flex-1 bg-slate-700/50"></div><span className="text-[10px] font-bold text-orange-400/50 uppercase tracking-wider">Jäskurva</span><div className="h-px flex-1 bg-slate-700/50"></div></div>
                                    <div className="bg-slate-900/50 p-6 rounded-lg border border-slate-700/50 overflow-visible">
                                        {graphData.length > 0 ? (
                                            <div className="h-48 w-full flex">
                                                <div className="w-10 flex flex-col justify-between items-end pr-2 text-[11px] text-slate-400 font-mono py-1">
                                                    <span>{Math.max(...graphData.map(d => d.value)) + 5}</span>
                                                    <span>{Math.round((Math.max(...graphData.map(d => d.value)) + Math.min(...graphData.map(d => d.value))) / 2)}</span>
                                                    <span>{Math.min(...graphData.map(d => d.value)) - 5}</span>
                                                </div>
                                                <div className="flex-1 flex flex-col">
                                                    <div className="flex-1 relative border-l border-b border-slate-700">
                                                        <svg className="absolute inset-0 w-full h-full overflow-visible" viewBox="0 0 100 100" preserveAspectRatio="none">
                                                            {[0, 25, 50, 75, 100].map(y => <line key={y} x1="0" y1={y} x2="100" y2={y} stroke="rgba(148,163,184,0.05)" strokeWidth="1" vectorEffect="non-scaling-stroke"/>)}
                                                            {graphData.length > 1 && (
                                                                <path d={`M ${graphData.map((pt, i) => {
                                                                    const x = (i / (graphData.length - 1)) * 100;
                                                                    const range = Math.max(...graphData.map(d => d.value)) + 5 - (Math.min(...graphData.map(d => d.value)) - 5);
                                                                    const y = 100 - ((pt.value - (Math.min(...graphData.map(d => d.value)) - 5)) / range * 100);
                                                                    return `${x} ${y}`;
                                                                }).join(' L ')}`} fill="none" stroke="rgba(251, 146, 60, 0.6)" strokeWidth="2" strokeDasharray="4 4" vectorEffect="non-scaling-stroke"/>
                                                            )}
                                                        </svg>
                                                        {graphData.map((pt, i) => {
                                                            const x = graphData.length > 1 ? (i / (graphData.length - 1)) * 100 : 0;
                                                            const range = Math.max(...graphData.map(d => d.value)) + 5 - (Math.min(...graphData.map(d => d.value)) - 5);
                                                            const y = 100 - ((pt.value - (Math.min(...graphData.map(d => d.value)) - 5)) / range * 100);
                                                            return <div key={i} className={`absolute w-2.5 h-2.5 rounded-full -ml-1.5 -mt-1.5 border-2 border-orange-400 group cursor-help ${pt.type==='start'?'bg-slate-900':'bg-orange-400'}`} style={{left: `${x}%`, top: `${y}%`}}><div className="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-800 text-orange-200 text-[11px] px-2 py-1 rounded border border-slate-700 z-50 whitespace-nowrap shadow-xl">{pt.value} °Oe ({pt.displayDate})</div></div>;
                                                        })}
                                                    </div>
                                                    <div className="h-6 relative mt-2">
                                                        {graphData.map((pt, i) => (i === 0 || i === graphData.length - 1 || graphData.length < 5 || i % Math.floor(graphData.length/2) === 0) && (
                                                            <div key={i} className="absolute text-[10px] text-slate-500 font-mono transform -translate-x-1/2" style={{left: `${graphData.length > 1 ? (i / (graphData.length - 1)) * 100 : 0}%`}}>{pt.displayDate}</div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        ) : <div className="h-32 w-full flex flex-col items-center justify-center text-[10px] text-slate-600 italic border border-dashed border-slate-800 rounded-lg">Ange OG och startdatum för att se kurvan.</div>}
                                    </div>
                                </div>
                            </section>
                        </div>
                    </main>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>

